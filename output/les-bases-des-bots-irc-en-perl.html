<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="perl" />
		<meta name="tags" content="irc" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Les bases des Bots IRC en perl</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:38+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/perl.html">perl</a></li>
				<li><a href="/tag/irc.html">irc</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p><a class="reference external" href="http://fr.wikipedia.org/wiki/Internet_Relay_Chat">IRC</a> est un réseau de chat bien connu et de nombreux bots (et utilisateurs standards d'ailleurs) y rodent.
Il existe énormément de manières et de moyens d'écrire un bot pour IRC et ce dans quasiment tous les langages.</p>
<p>Ici, nous allons nous intéresser à l'écriture d'un bot simple en perl à l'aide du module <tt class="docutils literal"><span class="pre">Bot::BasicBot</span></tt>.</p>
<div class="section" id="bot-basicbot">
<h2>Bot::BasicBot</h2>
<div class="section" id="installation">
<h3>Installation</h3>
<p>Pour installer ce magnifique module, deux options : soit vous avez configuré <tt class="docutils literal">CPAN.pm</tt> et vous pourrez utiliser :</p>
<div class="highlight"><pre><span></span>sudo cpan Bot::BasicBot
</pre></div>
<p>Soit vous ne l'avez pas configuré et vous préferez passer par <a class="reference external" href="https://raw.github.com/miyagawa/cpanminus/master/cpanm">cpanminus</a> :</p>
<div class="highlight"><pre><span></span>curl -L http://cpanmin.us <span class="p">|</span> perl - --sudo Bot::BasicBot
</pre></div>
<p>voire même sans <tt class="docutils literal">curl</tt> et en utilisant <tt class="docutils literal">wget</tt> :</p>
<div class="highlight"><pre><span></span>wget -O - http://cpanmin.us <span class="p">|</span> perl - --sudo Bot::BasicBot
</pre></div>
</div>
<div class="section" id="presentation-rapide">
<h3>Présentation (rapide)</h3>
<p><tt class="docutils literal"><span class="pre">Bot::BasicBot</span></tt> est un module plutot complet qui permet d'écrire facilement des bots IRC en utilisant la programmation évenementielle.</p>
<p>Celui-ci contient une classe dont le bot héritera et pour la personnalisation des actions, nous surchargerons certaines méthodes.</p>
</div>
</div>
<div class="section" id="bot-pour-absents">
<h2>Bot pour absents</h2>
<p>Notre objectif sera d'écrire un bot très simple qui devra signaler aux utilisateurs que son maître n'est pas là.</p>
<p>Il agira :</p>
<ul class="simple">
<li>quand un utilisateur se connecte (en lui disant que son maître est absent)</li>
<li>quand un utilisateur cite le nom de son maître (hl), dans une action ou un message classique</li>
</ul>
<p>La <a class="reference external" href="http://search.cpan.org/~hinrik/Bot-BasicBot-0.89/lib/Bot/BasicBot.pm">documentation</a> du module nous indique les méthodes à surcharger :</p>
<ul class="simple">
<li><tt class="docutils literal">chanjoin()</tt> pour la connexion</li>
<li><tt class="docutils literal">said()</tt> pour les messages classique</li>
<li><tt class="docutils literal">emoted()</tt> pour les <em>actions</em></li>
</ul>
<p>Notons que c'est la méthode <tt class="docutils literal">say()</tt> qui permet d'émettre un message.</p>
<div class="section" id="la-base">
<h3>La base</h3>
<p>Commençons par écrire la base de notre bot :</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env perl</span>

<span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Bot::BasicBot</span><span class="p">;</span>

<span class="k">package</span> <span class="nn">BotPasLa</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">base</span> <span class="sx">qw( Bot::BasicBot )</span><span class="p">;</span>

<span class="k">sub</span> <span class="nf">said</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="c1"># ... action si HL par message normal</span>
<span class="p">}</span>

<span class="k">sub</span> <span class="nf">emoted</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg_hl</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="c1"># ... action si HL par &quot;action&quot;</span>
<span class="p">}</span>

<span class="k">sub</span> <span class="nf">chanjoin</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="c1"># ... action si connexion d&#39;un user</span>
<span class="p">}</span>
<span class="mi">1</span><span class="p">;</span>
</pre></div>
<p>Rien de bien compliqué ici.</p>
<p>Il faut juste savoir qu'en Perl, les arguments sont passés aux fonctions via le tableau spécial : <tt class="docutils literal">&#64;_</tt>.</p>
<p>Lorsque l'on veut passer des tableaux ou des dictionnaires (<em>hashes</em>), on passe en fait une référence (scalaire) vers la structure voulue.</p>
<p>Ici, <tt class="docutils literal">$self</tt> est une référence vers l'objet (instance) lui-même et <tt class="docutils literal">$msg</tt> est une référence vers un <em>hash</em> contenant les infos relative au &quot;message&quot; reçu.</p>
</div>
<div class="section" id="et-si-on-le-faisait-parametrable">
<h3>Et si on le faisait paramétrable ?</h3>
<p>Ce qui est paramétrable (dans la mesure du raisonnable) est mieux, aussi essayons de faire en sorte que ce bot soit paramétrable à l'instanciation.</p>
<p>On va définir des attributs :</p>
<ul class="simple">
<li><tt class="docutils literal">$master</tt> : pseudo du maître du bot</li>
<li><tt class="docutils literal">$hl_regexp</tt> : regex pour détecter le HL</li>
<li><tt class="docutils literal">$msg_join</tt> : message à afficher quand un utilisateur se connecte</li>
<li><tt class="docutils literal">$msg_hl</tt> : message à afficher après un HL du maître</li>
</ul>
<p>Nous pourrons utiliser ces attributs dans le code du bot.</p>
<p>D'ailleurs, écrivons le ;)</p>
</div>
<div class="section" id="said-et-emoted">
<h3><tt class="docutils literal">said()</tt> et <tt class="docutils literal">emoted()</tt></h3>
<p>Ces fonctions font, pour ainsi dire la même chose : elles vérifient que le corps (<tt class="docutils literal"><span class="pre">$msg-&gt;{body}</span></tt>) correspond à la regex <tt class="docutils literal">$hl_regexp</tt>.</p>
<p>Si celle ci <em>matche</em>, alors on affiche le message correspondant <tt class="docutils literal">$msg_hl</tt> en l'adressant à l'utilisateur ayant parlé.</p>
<p>Par exemple, pour <tt class="docutils literal">said()</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">sub</span> <span class="nf">said</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">body</span><span class="p">}</span> <span class="o">=~</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">hl_regexp</span><span class="p">})</span> <span class="p">{</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
            <span class="n">who</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
            <span class="n">channel</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
            <span class="n">body</span><span class="o">=&gt;</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">msg_hl</span><span class="p">},</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Pour <tt class="docutils literal">emoted()</tt>, étant donné que les arguments qui lui sont passés sont les mêmes, la fonction est la même, à l'exception du nom.</p>
<p>Il aurait été possible d'écrire une seule fois la fonction (pour <tt class="docutils literal">said()</tt> par exemple) et de l'appeller dans l'autre.</p>
</div>
<div class="section" id="chanjoin">
<h3><tt class="docutils literal">chanjoin()</tt></h3>
<p>Enfin, la fonction <tt class="docutils literal">chanjoin()</tt> devra  vérifier qu'il ne va pas avertir son propre maître qu'il n'est pas là (ce serait particulièrement stupide) et qu'il ne va pas s'avertir lui même en lisant son propre message de connexion.</p>
<p>Ça donne quelque chose comme ça :</p>
<div class="highlight"><pre><span></span><span class="k">sub</span> <span class="nf">chanjoin</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}</span> <span class="ow">ne</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">master</span><span class="p">}</span> <span class="ow">and</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}</span> <span class="ow">ne</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">nick</span><span class="p">})</span> <span class="p">{</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
            <span class="n">who</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
            <span class="n">channel</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
            <span class="n">body</span><span class="o">=&gt;</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">msg_join</span><span class="p">},</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Là encore, un <tt class="docutils literal">say()</tt> sous conditionnelle.
Pour tester la différence de deux chaînes en Perl, on utilise <tt class="docutils literal">ne</tt> et non <tt class="docutils literal">!=</tt>.</p>
</div>
<div class="section" id="assemblage">
<h3>Assemblage</h3>
<p>Reste assembler tout ça et a instancier puis lancer le bot via son constructeur <tt class="docutils literal">new()</tt> et sa méthode <tt class="docutils literal">run()</tt> (définis par <tt class="docutils literal"><span class="pre">Bot::BasicBot</span></tt>).</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env perl</span>

<span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Bot::BasicBot</span><span class="p">;</span>

<span class="k">package</span> <span class="nn">BotPasLa</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">base</span> <span class="sx">qw( Bot::BasicBot )</span><span class="p">;</span>

<span class="k">sub</span> <span class="nf">said</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">body</span><span class="p">}</span> <span class="o">=~</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">hl_regexp</span><span class="p">})</span> <span class="p">{</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
            <span class="n">who</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
            <span class="n">channel</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
            <span class="n">body</span><span class="o">=&gt;</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">msg_hl</span><span class="p">},</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub</span> <span class="nf">emoted</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg_hl</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">body</span><span class="p">}</span> <span class="o">=~</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">hl_regexp</span><span class="p">})</span> <span class="p">{</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
            <span class="n">who</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
            <span class="n">channel</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
            <span class="n">body</span><span class="o">=&gt;</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">msg_hl</span><span class="p">},</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">sub</span> <span class="nf">chanjoin</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}</span> <span class="ow">ne</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">master</span><span class="p">}</span> <span class="ow">and</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}</span> <span class="ow">ne</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">nick</span><span class="p">})</span> <span class="p">{</span>
        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
            <span class="n">who</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
            <span class="n">channel</span><span class="o">=&gt;</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
            <span class="n">body</span><span class="o">=&gt;</span><span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">msg_join</span><span class="p">},</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="mi">1</span><span class="p">;</span>


<span class="k">my</span> <span class="nv">$bot</span> <span class="o">=</span> <span class="nn">BotPasLa</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
    <span class="n">server</span> <span class="o">=&gt;</span> <span class="s">&quot;irc.freenode.org&quot;</span><span class="p">,</span>
    <span class="n">channels</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&quot;#test_chan&quot;</span><span class="p">],</span>
    <span class="n">nick</span> <span class="o">=&gt;</span> <span class="s">&#39;pala&#39;</span><span class="p">,</span>
    <span class="n">charset</span><span class="o">=&gt;</span> <span class="s">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">master</span><span class="o">=&gt;</span><span class="s">&quot;matael&quot;</span><span class="p">,</span>
    <span class="n">hl_regexp</span><span class="o">=&gt;</span><span class="sx">qr/.*matael\W.*/</span><span class="p">,</span>
    <span class="n">msg_join</span><span class="o">=&gt;</span><span class="s">&quot;matael est pas lesa ;)&quot;</span><span class="p">,</span>
    <span class="n">msg_hl</span><span class="o">=&gt;</span><span class="s">&quot;Pas la peine de le HL, il est pas la ;)&quot;</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="lancement">
<h3>Lancement</h3>
<p>Le <em>shebang</em> nous permet, une fois rendu exécutable, de lancer le script ainsi (nous admettrons qu'il s'appelle <tt class="docutils literal">pala.pl</tt>):</p>
<div class="highlight"><pre><span></span>./pala.pl
</pre></div>
<p>Sinon, sachez qu'on peut le lancer de manière classique avec :</p>
<div class="highlight"><pre><span></span>perl pala.pl
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Bien que très simple, ce bot montre comment utiliser la classe fournie par <tt class="docutils literal"><span class="pre">Bot::BasicBot</span></tt>.</p>
<p>Notez qu'on peut parfaire ledit bot en retenant par exemple la liste des HL et en les transmettant au maître à son retour.
On peut aussi les lui transférer par mail, mais ce n'est pas l'objet de cet article.</p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>