<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="python" />
		<meta name="tags" content="arduino" />
		<meta name="tags" content="api" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Notifications Colissimo</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:41+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/arduino.html">arduino</a></li>
				<li><a href="/tag/api.html">api</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Parfois, certaines boites feraient bien de rendre leurs données plus accessibles.
Une de ces boites à qui l'ouverture d'une API publique pourrait profiter est La Poste.</p>
<p>J'attendais depuis quelque jours un colis et je cherchais un moyen d'afficher d'une manière ou d'une autre les
informations de suivi Colissimo quelque part sur mon bureau. Je me suis rendu sur leur <a class="reference external" href="http://www.colissimo.fr/portail_colissimo/suivre.do">site de suivi</a> et j'ai rentré
mon numéro et là, problème : il n'y a que des images sur cette page dans le genre :</p>
<img alt="" class="align-center" src="/static/images/colissimo/track.png" />
<p>Rien de bien cool en soi...</p>
<div class="section" id="partie-1-ocr">
<h2>Partie 1 : OCR</h2>
<p>Mon premier réflexe à été un peu masochiste : <em>&quot;Tiens ! Ça me donnera l'occasion de jouer avec une lib pour la
reconnaissance de caractères&quot;</em>.</p>
<p>J'en suis assez vite revenu : aucun lib ne permet de faire ça en <em>standalone</em> avec python et sortir l'excellent
<a class="reference external" href="http://code.google.com/p/tesseract-ocr/">Tesseract</a> pour ça relevait un peu de la bombe atomique pour déglinguer une taupe.</p>
<p>Je me suis donc rabattu sur ... une API :)</p>
</div>
<div class="section" id="partie-2-l-api-trop-bien-cachee">
<h2>Partie 2 : L'API (trop) bien cachée</h2>
<p>Ayant un téléphone Androïd, j'ai commencé par chercher de ce côté là si une application de suivi existait, et <a class="reference external" href="https://play.google.com/store/apps/details?id=fr.laposte.lapostetracking&amp;hl=fr">c'est le
cas</a>.</p>
<p>Après installation, on ouvre <a class="reference external" href="http://www.wireshark.org/">Wireshark</a> et on rentre le numéro de colis dans l'application et là, ô surprise !
Y'a tout plein de jolies requêtes HTTP qui ne demandaient qu'a être sniffées :)</p>
<p>On trouve donc nos éléments :</p>
<ul class="simple">
<li>un point d'entrée : <tt class="docutils literal"><span class="pre">http://www.laposte.fr/outilsuivi/web/suiviInterMetiers.php</span></tt></li>
<li>3 paramètres :<ul>
<li><tt class="docutils literal">key</tt> qui semble être une clef d'API pour laquelle la valeur <tt class="docutils literal">d112dc5c716d443af02b13bf708f73985e7ee943</tt>
fonctionne</li>
<li><tt class="docutils literal">method</tt> qui règle le format de retour : <tt class="docutils literal">json</tt> et <tt class="docutils literal">xml</tt> fonctionnnent. Si on ne met rien, une image est
retournée.</li>
<li><tt class="docutils literal">code</tt> qui est le code colis.</li>
</ul>
</li>
</ul>
<p>Pour le format JSON on obtient :</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;link&quot;</span> <span class="o">:</span> <span class="s2">&quot;http://www.coliposte.net/particulier/suivi_particulier.jsp?colispart=XXXXXXXXXXXXX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date&quot;</span> <span class="o">:</span> <span class="s2">&quot;11/05/2013&quot;</span><span class="p">,</span>
    <span class="s2">&quot;status&quot;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">&quot;gamme&quot;</span> <span class="o">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span> <span class="o">:</span> <span class="s2">&quot;Votre colis est arrivé sur son site de distribution&quot;</span><span class="p">,</span>
    <span class="s2">&quot;client&quot;</span> <span class="o">:</span> <span class="s2">&quot;Particulier&quot;</span><span class="p">,</span>
    <span class="s2">&quot;base_label&quot;</span> <span class="o">:</span> <span class="s2">&quot;Coliposte&quot;</span><span class="p">,</span>
    <span class="s2">&quot;error&quot;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="s2">&quot;code&quot;</span> <span class="o">:</span> <span class="s2">&quot;XXXXXXXXXXXXX&quot;</span>
<span class="p">}</span>
</pre></div>
<p>Reste à coder un petit truc pour faire ça. On va simplement boucler et envoyer le champ <tt class="docutils literal">message</tt> du JSON vers un
arduino et un écran LCD.</p>
<div class="section" id="code-python">
<h3>Code python</h3>
<p>Voilà le code python utilisé :</p>
<div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python</span>
<span class="c1"># -*- coding:utf8 -*-</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">serial</span> <span class="kn">import</span> <span class="n">Serial</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">loads</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;http://www.laposte.fr/outilsuivi/web/suiviInterMetiers.php?&quot;</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="s2">&quot;d112dc5c716d443af02b13bf708f73985e7ee943&quot;</span>
<span class="n">METHOD</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
<span class="n">PARCEL_NUM</span> <span class="o">=</span> <span class="s2">&quot;XXXXXXXXXXXXX&quot;</span>

<span class="n">URL</span> <span class="o">=</span> <span class="n">BASE_URL</span><span class="o">+</span><span class="s1">&#39;key=&#39;</span><span class="o">+</span><span class="n">KEY</span><span class="o">+</span><span class="s1">&#39;&amp;method=&#39;</span><span class="o">+</span><span class="n">METHOD</span><span class="o">+</span><span class="s1">&#39;&amp;code=&#39;</span><span class="o">+</span><span class="n">PARCEL_NUM</span>

<span class="c1"># init connection</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">(</span><span class="s1">&#39;/dev/ttyACM0&#39;</span><span class="p">,</span> <span class="mi">9600</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span>

<span class="c1"># boucle infinie</span>
<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;é&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;Votre colis est arrive sur son site de distribution&quot;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Site de distribution&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
<p>Rien de compliqué donc. J'envoie plusieurs fois le message pour des petits soucis de comminucation lors des tests.
A noter seulement la regex pour remplacer les <tt class="docutils literal">é</tt> et éviter un problème lors de l'encodage en ascii. Vous noterez
aussi l'ajout d'un <tt class="docutils literal">$</tt> à la fin de la chaine qui permet de signaler une fin de transmission (voir code pour l'arduino
ci dessous).</p>
</div>
<div class="section" id="cote-arduino">
<h3>Coté Arduino</h3>
<p>Pas de schéma pour cette fois ci, il suffit de relier un LCD en mode 4 broches à l'arduino donc selon le patch ::</p>
<pre class="literal-block">
Arduino 4 -&gt; LCD D4
Arduino 5 -&gt; LCD D5
Arduino 6 -&gt; LCD D6
Arduino 7 -&gt; LCD D7
Arduino 8 -&gt; LCD RS (Register Select)
Arduino 9 -&gt; LCD E (Enable)
GND -&gt; LCD VSS
GND -&gt; LCD RW (Read/Write)
+5V -&gt; LCD VDD
+5V -&gt; LCD A (rétroéclairage)
Potar entre +5V et GND -&gt; LCD V0 (contraste)
Potar entre +5V et GND (un autre) -&gt; LCD K (rétroéclairage)
</pre>
<p>Ensuite, un peu de code :</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;liquidcrystal.h&gt;</span><span class="cp"></span>

<span class="c1">// instanciation du LCD</span>
<span class="n">LiquidCrystal</span> <span class="nf">lcd</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// init. du LCD</span>
    <span class="n">lcd</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="c1">// init. de la conn. série</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// buffer d&#39;entrée série et byte d&#39;entrée</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">incoming</span><span class="p">;</span>

<span class="c1">// Loop</span>
<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// seulement s&#39;il y a des données</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>

        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="c1">// On initialise le buffer à &#39; &#39;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span> <span class="p">}</span>

        <span class="c1">// récupération des données depuis la liaison série</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">incoming</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
            <span class="c1">// test pour la valeur sentinelle</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">incoming</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">incoming</span><span class="p">;</span>
                <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// on vide le tampon d&#39;entrée</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>

        <span class="c1">// affichage sur le LCD (en deux lignes)</span>
        <span class="n">lcd</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span> <span class="c1">// RAZ</span>
        <span class="n">lcd</span><span class="p">.</span><span class="n">setCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// première ligne</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);}</span>
        <span class="n">lcd</span><span class="p">.</span><span class="n">setCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// deuxième ligne</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);}</span>


        <span class="c1">// on attends 4s</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Et voilà !</p>
<p>Et on arrive à un résultat plutot potable (en tout cas suffisant) :</p>
<img alt="" class="align-center" src="/static/images/colissimo/result.jpg" style="width: 500px;" />
<p>Voilà donc petit contournement simple d'une limitation stupide et injustifiée de cette API Colissimo.</p>
<p>Pourquoi s'obstiner à cacher des API ? Pourquoi ne pas les rendre directement accessibles ? Tout le monde gagnerait du
temps...</p>
</div>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>