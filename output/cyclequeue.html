<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="python" />
		<meta name="tags" content="ambilight" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>CycleQueue</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:40+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/ambilight.html">ambilight</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Pour un très prochain article sur l'<a class="reference external" href="http://blog.matael.org/writing/a-first-try-at-ambilight/">ambilight</a>, nous allons avoir besoin d'une version augmentée de <tt class="docutils literal">Queue.Queue</tt>.</p>
<p>Cette classe (faisant partie de la bibliothèque standard de python) permet de créer une file d'attente. Elle simplifie
part ailleurs la gestion de la communication entre <em>threads</em>.</p>
<p>Nous allons l'étendre de manière à pouvoir mémoriser un état de la file et revenir à tout moment à cet état.
Le <em>workflow</em> final attendu est le suivant :</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">CycleQueue</span>

<span class="c1"># instanciation</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">CycleQueue</span><span class="p">()</span>

<span class="c1"># utilisation comme une Queue classique</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># vérrouillage de l&#39;état courant</span>
<span class="n">q</span><span class="o">.</span><span class="n">lockstate</span><span class="p">()</span>

<span class="c1"># utilisation comme une Queue classique</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="c1"># faire des trucs</span>
    <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">)()</span>

<span class="c1"># restoration de l&#39;état verrouillé</span>
<span class="n">q</span><span class="o">.</span><span class="n">reinit</span><span class="p">()</span>

<span class="c1"># etc...</span>
</pre></div>
<div class="section" id="ecriture-de-la-classe">
<h2>Ecriture de la classe</h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">Queue</span>

<span class="k">class</span> <span class="nc">CycleQueue</span><span class="p">(</span><span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Particular Queue with new method reinit to get back to</span>
<span class="sd">    initial state.</span>

<span class="sd">    Standard use :</span>

<span class="sd">        q = CycleQueue()</span>

<span class="sd">        q.put(&#39;elem1&#39;)</span>
<span class="sd">        q.put(&#39;elem2&#39;)</span>
<span class="sd">        # etc...</span>

<span class="sd">        # lock current state, say state1</span>
<span class="sd">        q.lockstate()</span>

<span class="sd">        q.get()</span>
<span class="sd">        # etc... &#39;till queue is empty</span>

<span class="sd">        q.reinit() # get back to state1</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">lockstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lock current state &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">reinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get back to previous locked state &quot;&quot;&quot;</span>

        <span class="c1"># check if a non-empty backup exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Backup list is empty&#39;</span><span class="p">)</span>

        <span class="c1"># reset the queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># push locked elements back to queue</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
<p>Le code n'a rien de très compliqué. Notez simplement l'utilsation des variables <tt class="docutils literal">*args</tt> et <tt class="docutils literal">**args</tt> pour le passage
de tous les arguments d'un coup.</p>
<p>En fait, on vient juste cloner la classe <tt class="docutils literal">Queue.Queue()</tt> et lui ajouter les 2 méthodes utiles. On s'assure ainsi une
compatibilité parfaite avec celle ci.</p>
</div>
<div class="section" id="tests">
<h2>Tests</h2>
<p>Nous allons aussi écrire quelques tests pour s'assurer du bon fonctionnement de notre extension :</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">CycleQueue</span>

<span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">TestCycleQueue</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>


    <span class="c1"># test pour la fonction lockstate()</span>
    <span class="k">def</span> <span class="nf">test_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># instanciation d&#39;une CycleQueue</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">CycleQueue</span><span class="p">()</span>

        <span class="c1"># ajout d&#39;éléments</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># verrouillage</span>
        <span class="n">q</span><span class="o">.</span><span class="n">lockstate</span><span class="p">()</span>

        <span class="c1"># vérification du backup</span>
        <span class="c1"># le test ne passe pas si un élément du backup</span>
        <span class="c1"># diffère de son semblable dans la queue</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                <span class="n">q</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="c1"># test de reinit()</span>
    <span class="k">def</span> <span class="nf">test_reinit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># instanciation</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">CycleQueue</span><span class="p">()</span>

        <span class="c1"># on charge la file</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="c1"># on la verrouille</span>
        <span class="n">q</span><span class="o">.</span><span class="n">lockstate</span><span class="p">()</span>

        <span class="c1"># on supprime quelques éléments</span>
        <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">();</span> <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
        <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">();</span> <span class="n">q</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

        <span class="c1"># ré-initialisation</span>
        <span class="n">q</span><span class="o">.</span><span class="n">reinit</span><span class="p">()</span>

        <span class="c1"># on vérifie la conformité vis à vis de la</span>
        <span class="c1"># liste originelle</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
                <span class="n">q</span><span class="o">.</span><span class="n">_backup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
<p>Rien de compliqué là non plus, simplement quelques tests.</p>
<p>On va s'arrêter là donc :)</p>
<p>Vous pouvez lancer les tests via :</p>
<div class="highlight"><pre><span></span>$ python utilities_tests.py
</pre></div>
<p>On aurait pu tester aussi que l'exception <tt class="docutils literal">IndexError</tt> était bien levée, mais cela n'a pas grande utilité. Une autre
fois peut être.</p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>