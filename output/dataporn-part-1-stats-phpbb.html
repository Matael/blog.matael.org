<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="perl" />
		<meta name="tags" content="datalove" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Dataporn Part #1 : Stats phpBB</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:38+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/perl.html">perl</a></li>
				<li><a href="/tag/datalove.html">datalove</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Depuis quelques jours, je vais joujou avec le module <tt class="docutils literal"><span class="pre">SVG::TT::Graph</span></tt> sous Perl.
Pour faire court, <a class="reference external" href="http://search.cpan.org/~fangly/SVG-TT-Graph-0.21/">ce module</a> permet de tracer plein de graphiques cools facilement.</p>
<p>Ici, nous allons nous intéresser à un cas simple : tracer un graphique du nombre de posts par personne sur <a class="reference external" href="http://www.phpbb.com">phpBB</a>.</p>
<object class="align-center" data="/static/images/dataporn/phpbb.svg" style="width: 600px;" type="image/svg+xml">
</object>
<p>Le but est donc de générer un graphe comme celui ci-contre.</p>
<div class="section" id="la-db-de-phpbb">
<h2>La DB de phpBB</h2>
<p>phpBB peut utiliser plusieurs SGDB, l'instance tournant chez moi est sous <a class="reference external" href="http:/postgresql.org">PostGreSQL</a>.</p>
<p>Ce qui nous intéresse, c'est :</p>
<ul class="simple">
<li>le nom d'utilisateur (<tt class="docutils literal">username</tt>)</li>
<li>le nombre de posts (<tt class="docutils literal">user_posts</tt>)</li>
</ul>
<p>Ces deux champs sont dans la table <tt class="docutils literal">&lt;prefixe&gt;users</tt> où <tt class="docutils literal">&lt;prefixe&gt;</tt> est le préfixe choisi à l'installation de phpBB.</p>
<p><em>Note: pour ceux qui ne se souviennent plus, la conf de phpBB est disponible dans le fichier ``config.php`` de l'installation du forum.</em></p>
<p>En Perl, c'est le module <tt class="docutils literal">DBI</tt> qui gère les connexions aux DBs SQL (ce n'est pas le seul, mais il le fait très bien).
On aura aussi besoin de <tt class="docutils literal"><span class="pre">DBD::Pg</span></tt> pour spécifier une connexion à PostGreSQL.</p>
</div>
<div class="section" id="l-installation-des-modules">
<h2>L'installation des modules</h2>
<p>Histoire de pas s'embêter, on va passer par <a class="reference external" href="http://cpanmin.us">cpanmin.us</a></p>
<pre class="literal-block">
curl -L http://cpanmin.us | perl - --sudo SVG::TT::Graph
</pre>
<p>ou, sans <tt class="docutils literal">curl</tt></p>
<pre class="literal-block">
wget -O - ttp://cpanmin.us | perl - --sudo SVG::TT::Graph
</pre>
<p>On pourra utiliser le gestionnaires de paquets de la distribution pour <tt class="docutils literal"><span class="pre">DBD::Pg</span></tt> (<tt class="docutils literal">CPAN</tt> n'ayant pas voulu me l'installer ici)</p>
<pre class="literal-block">
sudo apt-get install libdbd-pg-perl
</pre>
<p>pour une distro <em>Deban-based</em>.</p>
</div>
<div class="section" id="ecriture-du-script">
<h2>Ecriture du script</h2>
<div class="section" id="cueillons-les-donnees">
<h3>Cueillons les données</h3>
<p>On va commencer par écrire le début du script où l'on va chercher les données.
La seconde partie consistera à les mettre sous forme de graphe.</p>
<p>Commençons par une série de variables de config pour pouvoir facilement réutiliser le script :</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env perl</span>

<span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">DBI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">SVG::TT::Graph::BarHorizontal</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="s">&quot;user_for_db&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="s">&quot;pass_for_this_user&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dbname</span> <span class="o">=</span> <span class="s">&quot;phpbb&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s">&quot;phpbb_&quot;</span><span class="p">;</span>

<span class="c1"># pour tout à l&#39;heure</span>
<span class="k">my</span> <span class="nv">$graph_title</span> <span class="o">=</span> <span class="s">&quot;titre du graphe&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$graph_subtitle</span> <span class="o">=</span> <span class="s">&quot;sous-titre&quot;</span><span class="p">;</span>
</pre></div>
<p>Les noms des variables parlent d'eux mêmes.
Notez que j'inclue systématiquement : <tt class="docutils literal">warnings</tt> et <tt class="docutils literal">strict</tt> qui forcent le développeur à coder proprement.</p>
<p>Il nous faut maintenant aller chercher les données, et donc ouvrir une connexion vers la DB :</p>
<div class="highlight"><pre><span></span><span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="nn">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span>
    <span class="s">&quot;dbi:Pg:host=localhost;dbname=$dbname&quot;</span><span class="p">,</span> <span class="c1"># DSN</span>
    <span class="nv">$user</span><span class="p">,</span> <span class="nv">$passwd</span><span class="p">,</span> <span class="p">{</span><span class="n">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">);</span>
</pre></div>
<p>La chaine <tt class="docutils literal">DSN</tt> reprend le nom du module de liaison (<tt class="docutils literal">dbi</tt>), le SGDB (<tt class="docutils literal">Pg</tt>), l'<em>host</em> et le nom de la db (<tt class="docutils literal">dbname</tt>).</p>
<p>On récupère ensuite une liste d'<em>users</em>.
Ici, dans la requête SQL (<tt class="docutils literal">$sql</tt>), on filtre un peut en ne prenant que les <em>users</em> ayant plus de 10 posts, pour éviter de surcharger le graphe.</p>
<div class="highlight"><pre><span></span><span class="c1"># get users</span>
<span class="k">my</span> <span class="nv">$sql</span> <span class="o">=</span> <span class="s">&quot;SELECT username,user_posts FROM &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;users WHERE user_posts&gt;10&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchall_hashref</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">);</span>
</pre></div>
<p>Ici, le cheminement est classique</p>
<pre class="literal-block">
connect -&gt; prepare -&gt; execute -&gt; fetch
</pre>
<p>Notez que la variable <tt class="docutils literal">$prefix</tt> est <em>interpolée</em> dans la chaine de requête SQL.
Cette pratique est déconseillée, mais ici, <tt class="docutils literal">$prefix</tt> est règlée par l'admin lui même, à moins qu'il soit stupide, il ne devrait pas se faire de mal...</p>
<p>On passe ensuite cette requête à <tt class="docutils literal"><span class="pre">$dbh-&gt;prepare()</span></tt> qui renvoie un <em>Statement handler</em> stocké ici dans <tt class="docutils literal">$sth</tt>.
Enfin, on éxécute cette requête avec la méthode <tt class="docutils literal">execute()</tt> de <tt class="docutils literal">$sth</tt>.</p>
<p>La méthode <tt class="docutils literal">fetchall_hashref</tt> permet de récupérer les résultats sous forme d'une <em>hashref</em>, elle prend en paramètre le nom d'un champ dont la valeur est unique pour chaque champ.</p>
<p><strong>ATTENTION : Ici, la méthode que je vous présente fonctionne mais n'implémente aucune gestion des erreurs. Ce script peut être considéré safe ici parce que l'on sait ce qu'il y a dans la base. En production, il faudrait faire attention aux retours des méthodes et aux erreurs.</strong></p>
</div>
<div class="section" id="le-graphe">
<h3>Le graphe</h3>
<p>Avant d'utiliser le beau module cité au début, on aura besoin de générer deux tableaux, un pour les étiquettes (<tt class="docutils literal">&#64;fields</tt>) et l'autre pour les données (<tt class="docutils literal">&#64;posts</tt>).</p>
<p>Vu notre utilisation de <tt class="docutils literal">fetchall_hashref</tt> il nous suffit d'utiliser les clés de <tt class="docutils literal"><span class="pre">%{$results}</span></tt> pour générer le premier.</p>
<p>Pour le deuxième, on parcours le <tt class="docutils literal">&#64;fields</tt> et pour chaque clé, on ajoute la valeur de <tt class="docutils literal"><span class="pre">$results-&gt;{clé}-&gt;{user_posts}</span></tt> tableau <tt class="docutils literal">&#64;posts</tt> qu'on aura créé avant sans l'initialiser.</p>
<div class="highlight"><pre><span></span><span class="k">my</span> <span class="nv">@fields</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$results</span><span class="p">};</span>

<span class="k">my</span> <span class="nv">@posts</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$k</span> <span class="p">(</span><span class="nv">@fields</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">push</span> <span class="nv">@posts</span><span class="p">,</span> <span class="nv">$results</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$k</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">user_posts</span><span class="p">};</span>
<span class="p">}</span>
</pre></div>
<p><em>Note: la fonction ``push`` permet d'ajouter à la fin d'un tableau.</em></p>
<p>Finalement, on suit <a class="reference external" href="http://search.cpan.org/~fangly/SVG-TT-Graph-0.19/lib/SVG/TT/Graph/BarHorizontal.pm">la doc</a> de <tt class="docutils literal"><span class="pre">SVG::TT::Graph::BarHorizontal</span></tt> pour créer le graphe qui nous convient :</p>
<div class="highlight"><pre><span></span><span class="k">my</span> <span class="nv">$graph</span>  <span class="o">=</span> <span class="nn">SVG::TT::Graph::BarHorizontal</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">({</span>
    <span class="s">&#39;height&#39;</span>                                <span class="o">=&gt;</span> <span class="s">&#39;700&#39;</span><span class="p">,</span>
    <span class="s">&#39;width&#39;</span>                                 <span class="o">=&gt;</span> <span class="s">&#39;600&#39;</span><span class="p">,</span>
    <span class="s">&#39;fields&#39;</span>                                <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@fields</span><span class="p">,</span>
    <span class="s">&#39;graph_title&#39;</span>                   <span class="o">=&gt;</span> <span class="nv">$graph_title</span><span class="p">,</span> <span class="c1"># défini au début</span>
    <span class="s">&#39;show_graph_title&#39;</span>              <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;graph_subtitle&#39;</span>                <span class="o">=&gt;</span> <span class="nv">$graph_subtitle</span><span class="p">,</span> <span class="c1"># idem</span>
    <span class="s">&#39;show_graph_subtitle&#39;</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;scale_integers&#39;</span>                <span class="o">=&gt;</span> <span class="mi">1</span>
<span class="p">});</span>

<span class="nv">$graph</span><span class="o">-&gt;</span><span class="n">add_data</span><span class="p">({</span>
    <span class="s">&#39;data&#39;</span>          <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@posts</span><span class="p">,</span>
    <span class="s">&#39;title&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;Posts&#39;</span> <span class="c1"># titre pour cette série</span>
<span class="p">});</span>
</pre></div>
<p>On passe bien des <strong>références</strong> sur les tableaux, Perl ne permettant que des scalaire dans les paramètres.</p>
<p>Pour ce qui est de l'instanciation, je ne détaillerais pas : les noms sont déjà assez explicites.</p>
</div>
</div>
<div class="section" id="affichage">
<h2>Affichage</h2>
<p>On ne s'embetera pas à gèrer l'écriture dans un fichier, le SVG n'étant que du texte, on l'écrira sur la sortie standard, libre à nous de le rediriger ailleurs ensuite (dans un fichier par exemple).</p>
<p>C'est la méthode <tt class="docutils literal">burn()</tt> qui permet de générer le SVG final, on utilisera <tt class="docutils literal">print</tt> pour l'afficher :</p>
<div class="highlight"><pre><span></span><span class="k">print</span> <span class="nv">$graph</span><span class="o">-&gt;</span><span class="n">burn</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="fin">
<h2>Fin</h2>
<p>Histoire de bien faire, voici le code complet du script, suivi d'un exemple d'utilisation :</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env perl</span>

<span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">DBI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">SVG::TT::Graph::BarHorizontal</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$user</span> <span class="o">=</span> <span class="s">&quot;user_for_db&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$passwd</span> <span class="o">=</span> <span class="s">&quot;pass_for_this_user&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$dbname</span> <span class="o">=</span> <span class="s">&quot;phpbb&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s">&quot;phpbb_&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$graph_title</span> <span class="o">=</span> <span class="s">&quot;titre du graphe&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$graph_subtitle</span> <span class="o">=</span> <span class="s">&quot;sous-titre&quot;</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="nn">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span>
    <span class="s">&quot;dbi:Pg:host=localhost;dbname=$dbname&quot;</span><span class="p">,</span>
    <span class="nv">$user</span><span class="p">,</span> <span class="nv">$passwd</span><span class="p">,</span> <span class="p">{</span><span class="n">RaiseError</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">);</span>

<span class="c1"># get users</span>
<span class="k">my</span> <span class="nv">$sql</span> <span class="o">=</span> <span class="s">&quot;SELECT username,user_posts FROM &quot;</span><span class="o">.</span><span class="nv">$prefix</span><span class="o">.</span><span class="s">&quot;users WHERE user_posts&gt;10&quot;</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$sth</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
<span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>
<span class="k">my</span> <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$sth</span><span class="o">-&gt;</span><span class="n">fetchall_hashref</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">@fields</span> <span class="o">=</span> <span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$results</span><span class="p">};</span>

<span class="k">my</span> <span class="nv">@posts</span><span class="p">;</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="nv">$k</span> <span class="p">(</span><span class="nv">@fields</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">push</span> <span class="nv">@posts</span><span class="p">,</span> <span class="nv">$results</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$k</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">user_posts</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$graph</span>  <span class="o">=</span> <span class="nn">SVG::TT::Graph::BarHorizontal</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">({</span>
    <span class="s">&#39;height&#39;</span>                                <span class="o">=&gt;</span> <span class="s">&#39;700&#39;</span><span class="p">,</span>
    <span class="s">&#39;width&#39;</span>                                 <span class="o">=&gt;</span> <span class="s">&#39;600&#39;</span><span class="p">,</span>
    <span class="s">&#39;fields&#39;</span>                                <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@fields</span><span class="p">,</span>
    <span class="s">&#39;graph_title&#39;</span>                   <span class="o">=&gt;</span> <span class="nv">$graph_title</span><span class="p">,</span>
    <span class="s">&#39;show_graph_title&#39;</span>              <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;graph_subtitle&#39;</span>                <span class="o">=&gt;</span> <span class="nv">$graph_subtitle</span><span class="p">,</span>
    <span class="s">&#39;show_graph_subtitle&#39;</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;scale_integers&#39;</span>                <span class="o">=&gt;</span> <span class="mi">1</span>
<span class="p">});</span>

<span class="nv">$graph</span><span class="o">-&gt;</span><span class="n">add_data</span><span class="p">({</span>
    <span class="s">&#39;data&#39;</span>          <span class="o">=&gt;</span> <span class="o">\</span><span class="nv">@posts</span><span class="p">,</span>
    <span class="s">&#39;title&#39;</span>         <span class="o">=&gt;</span> <span class="s">&#39;Posts&#39;</span>
<span class="p">});</span>

<span class="k">print</span> <span class="nv">$graph</span><span class="o">-&gt;</span><span class="n">burn</span><span class="p">();</span>
</pre></div>
<p>On pourra appeller le module et placer le SVG généré dans <tt class="docutils literal">phpbb.svg</tt> <em>via</em> :</p>
<div class="highlight"><pre><span></span>perl mon_script.pl &gt; phpbb.svg
</pre></div>
<p>et vous pourrez sans problème visualiser le svg ainsi créé.</p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>