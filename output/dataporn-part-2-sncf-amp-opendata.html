<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="python" />
		<meta name="tags" content="datalove" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Dataporn Part #2 : Sncf &amp;amp; OpenData</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:39+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/datalove.html">datalove</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Après un <a class="reference external" href="http://www.sncfapplilab.com/feedbacks/65286-ouvrir-les-sources-des-applications-et-creer-une-communaute-de-developpeurs">post de Denis Bodor</a> sur <a class="reference external" href="http://www.sncfapplilab.com/">SNCF Appli Lab</a>, la SNCF a commencé à envisager sérieusement l'ouverture d'une partie de ses données.
Aujourd'hui, plus d'un an après ce post, un site existe et propose d'ouvrir le débat autour de l'OpenData : <a class="reference external" href="http://data.sncf.com/">data.sncf.com</a>.
On y trouvera notamment un lien vers un site (apparement en test) proposant les <a class="reference external" href="http://test.data-sncf.com/">premiers jeux de données ouverts</a>.</p>
<div class="section" id="nos-donnees">
<h2>Nos données</h2>
<p>Dans cet article, nous nous intéresserons aux données d'avril 2012 sur la ponctualité des TGV (<a class="reference external" href="http://test.data-sncf.com/index.php?p=voyages-sncf">disponible ici</a>).
Il s'agit d'un fichier <a class="reference external" href="http://fr.wikipedia.org/wiki/Comma-separated_values">CSV</a> contenant 4 colonnes :</p>
<ul class="simple">
<li>Départ</li>
<li>Arrivée</li>
<li>Nb de circulations</li>
<li>Nb trains en retard à l'arrivée</li>
</ul>
<p>Ensuite, suivent 114 lignes de données.</p>
</div>
<div class="section" id="processing">
<h2>Processing</h2>
<p>Avant toute chose, il vous faudra deux modules python pour aller au bout de cet
article.</p>
<p>Le premier est le module <tt class="docutils literal">csv</tt> normalement inclus par défaut dans la
distribution standard de python.
Ce module permettra de lire le fichier CSV plus facilement que si nous avions dû
réécrire un parser à la main ;)</p>
<p>Le second module permet lui de tracer des graphes.
Il s'agit en fait du pendant python du module <tt class="docutils literal"><span class="pre">SVG::TT::Graph</span></tt> que nous avions
utilisé en perl dans <a class="reference external" href="http://blog.matael.org/writing/dataporn-part-1-stats-phpbb/">cet article</a>, en python, il s'appelle <tt class="docutils literal">svg.charts</tt>.</p>
<p>Finalement, les deux seules choses à savoir c'est que ce module
(disponibles dans plusieurs langages) est porté depuis Ruby et qu'en python, on
peut l'installer comme ça :</p>
<div class="highlight"><pre><span></span>sudo pip install svg.charts
</pre></div>
<p>Notez enfin que, tournant sur ArchLinux, j'ai rédigé ce script pour <strong>python3</strong>.</p>
<div class="section" id="pre-traitement">
<h3>Pré-traitement</h3>
<div class="section" id="doublons">
<h4>Doublons</h4>
<p>Nous allons essayer de créer un graphe recensant le pourcentage de trains à l'heure et de trains en retard pour chaque trajet.</p>
<p>En observant les données, on remarque que l'aller et le retour d'un même trajet sont recensés dans 2 lignes différentes ainsi, il nous faudra regrouper les enregistrements aller et retour.</p>
<p>Par exemple, on passera de</p>
<pre class="literal-block">
PARIS MONTPARNASSE;ANGOULEME;318;28
ANGOULEME;PARIS MONTPARNASSE;348;53
</pre>
<p>à</p>
<pre class="literal-block">
PARIS MONTPARNASSE;ANGOULEME;666;81
</pre>
<p>Ça, on le fera au dernier moment, dans le script lui même.</p>
</div>
<div class="section" id="noms-de-champs">
<h4>Noms de champs</h4>
<p>Si on regarde la première ligne du fichier de données (que nous appellerons <tt class="docutils literal">data.csv</tt>), on remarque que les noms de colonne sont longs.</p>
<p>On va raccourcir tout ça (juste pour simplifier, le script aurait très bien pu marcher sans ça ;) ) et le transformer en</p>
<pre class="literal-block">
D;A;NbTotal;NbRetards
</pre>
<p>Maintenant que nous avons un peu retouché les données pour simplifier le script et analyser la modif que nous aurons à faire au cours du traitement, passons aux choses sérieuses</p>
</div>
</div>
<div class="section" id="traitement">
<h3>Traitement</h3>
<p>Comme d'habitude, écrivons une base :</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#-*-coding:utf8-*-</span>
<span class="c1">#</span>
<span class="c1"># File: graph.py</span>
<span class="c1"># Author: Mathieu (matael) Gaborit</span>
<span class="c1">#       &lt;mat.gaborit@gmx.com&gt;</span>
<span class="c1"># Date: 2012</span>
<span class="c1"># License: WTFPL</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># Module pour les fichiers CSV</span>
<span class="kn">import</span> <span class="nn">csv</span>

<span class="c1"># Module pour le graphe</span>
<span class="c1"># Ici, juste la classe pour les histogrammes</span>
<span class="kn">from</span> <span class="nn">svg.charts</span> <span class="kn">import</span> <span class="n">bar</span>


<span class="c1"># Fichier d&#39;entrée</span>
<span class="n">FILENAME</span> <span class="o">=</span> <span class="s1">&#39;data.csv&#39;</span>

<span class="c1"># Fichier de sortie (SVG)</span>
<span class="n">OUTFILE</span> <span class="o">=</span> <span class="s1">&#39;ponct_TGV.svg&#39;</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Main function &quot;&quot;&quot;</span>

    <span class="c1"># Calcul des doublons, préparation des données depuis data.csv</span>

    <span class="c1"># Graphe</span>


<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span><span class="n">main</span><span class="p">()</span>
</pre></div>
<div class="section" id="doublons-et-pourcentages">
<h4>Doublons et pourcentages</h4>
<p>Pour l'utilisation du module <tt class="docutils literal">csv</tt>, je vous renvoie à sa très bonne <a class="reference external" href="http://docs.python.org/library/csv.html">doc</a>.</p>
<p>Le code lui même est assez commenté pour être clair :</p>
<div class="highlight"><pre><span></span><span class="c1"># initialisation d&#39;une liste vide,</span>
<span class="c1"># elle contiendra les enregistrements</span>
<span class="n">liste</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># ouverture du fichier CSV via le module qui va bien</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">FILENAME</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

<span class="c1"># Pour chaque ligne du fichier</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>

    <span class="c1"># on considère qu&#39;elle n&#39;existe pas dans la liste</span>
    <span class="n">exists</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># on parcourt la liste actuelle</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">liste</span><span class="p">:</span>

        <span class="c1"># si un enregistrement de la liste a :</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>\       <span class="c1"># même départ que l&#39;arrivée de l&#39;enregistrement courant</span>
           <span class="ow">and</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]:</span>   <span class="c1"># et même arrivée que le départ du courant</span>

            <span class="n">i</span><span class="p">[</span><span class="s1">&#39;NbTotal&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;NbTotal&#39;</span><span class="p">]</span>     <span class="c1"># on ajoute les deux nombres de trains</span>
            <span class="n">i</span><span class="p">[</span><span class="s1">&#39;NbRetards&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;NbRetards&#39;</span><span class="p">]</span> <span class="c1"># et les nombres de retards</span>
            <span class="n">exists</span><span class="o">=</span><span class="bp">True</span> <span class="c1"># on précise ensuite que l&#39;enregistrement à été trouvé dans la liste</span>
            <span class="k">break</span> <span class="c1"># On sort alors du for</span>

    <span class="c1"># Si on a pas trouvé l&#39;enregistrement dans la liste</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">:</span>

        <span class="c1"># on l&#39;y ajoute</span>
        <span class="n">liste</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="graphe">
<h4>Graphe</h4>
<p>On va ensuite devoir écrire le bout de code permettant de générer le SVG final.</p>
<div class="highlight"><pre><span></span><span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># liste des champs (noms de trajets ici)</span>
<span class="n">retards</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># en retard</span>
<span class="n">ok</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># à l&#39;heure</span>

<span class="c1"># pour chaque élément de la liste</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">liste</span><span class="p">:</span>
    <span class="c1"># On ajoute un champ à la liste dans le genre :</span>
    <span class="c1"># Destination1 &lt;-&gt; Destination2</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{} &lt;-&gt; {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]))</span>

    <span class="c1"># On définit un hash contenant les différents nombres utiles</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;NbTotal&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;retards&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;NbRetards&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;ok&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;NbTotal&#39;</span><span class="p">])</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;NbRetards&#39;</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="c1"># Attention, csv ne renvoie que des str, d&#39;où la fonction int()</span>

    <span class="c1"># on ajoute à la fin de la liste le pourcentage de retard pour ce trajet</span>
    <span class="n">retards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="p">[</span><span class="s1">&#39;retards&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">nb</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># idem pour le pourcentage de trains à l&#39;heure</span>
    <span class="n">ok</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">nb</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
<p>Voilà pour la préparation du terrain.
Reste à établir le graphe lui même :</p>
<div class="highlight"><pre><span></span><span class="c1"># g =&gt; objet de type VerticalBar avec les champs définis plus haut</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">bar</span><span class="o">.</span><span class="n">VerticalBar</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

<span class="c1"># options</span>
<span class="n">g</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="s1">&#39;side&#39;</span>                <span class="c1"># les jeux de données seront affichés côte à</span>
                                <span class="c1"># côte. Mettre &#39;top&#39; pour un empilement</span>
<span class="n">g</span><span class="o">.</span><span class="n">show_graph_title</span> <span class="o">=</span> <span class="bp">True</span>       <span class="c1"># On affiche le titre (il est défini en dessous)</span>
<span class="n">g</span><span class="o">.</span><span class="n">graph_title</span> <span class="o">=</span> <span class="s2">&quot;Pourcentage de trains à l&#39;heure/en retard en Avril 2012 (source SNCF)&quot;</span>
<span class="n">g</span><span class="o">.</span><span class="n">show_data_values</span> <span class="o">=</span> <span class="bp">False</span>      <span class="c1"># On n&#39;affiche pas de valeur numériques</span>
<span class="n">g</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span><span class="mi">700</span>    <span class="c1"># On définit hauteur et largeur</span>
<span class="n">g</span><span class="o">.</span><span class="n">rotate_x_labels</span> <span class="o">=</span> <span class="bp">True</span>        <span class="c1"># Les noms de champ (en abscisse) seront</span>
                                <span class="c1"># tournés de 90° (plus lisible)</span>
<span class="n">g</span><span class="o">.</span><span class="n">scale_integers</span> <span class="o">=</span> <span class="bp">True</span>         <span class="c1"># Les repères en fond seront à des nombres entiers</span>
<span class="n">g</span><span class="o">.</span><span class="n">font_size</span> <span class="o">=</span> <span class="mi">10</span>                <span class="c1"># taille de police (peu important)</span>


<span class="c1"># Ajout du premier jeu de données : trains à l&#39;heure</span>
<span class="n">g</span><span class="o">.</span><span class="n">add_data</span><span class="p">({</span>
    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ok</span><span class="p">,</span>                 <span class="c1"># la liste contenant les données</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s2">&quot;Trains à l&#39;heure&quot;</span> <span class="c1"># le titre (pour la légende)</span>
<span class="p">})</span>

<span class="c1"># Ajout du second jeu de données : trains en retard</span>
<span class="n">g</span><span class="o">.</span><span class="n">add_data</span><span class="p">({</span>
    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">retards</span><span class="p">,</span>
    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s2">&quot;Trains en retard&quot;</span>
<span class="p">})</span>

<span class="c1"># on ouvre le fichier de sortie en mode write et binary</span>
<span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">OUTFILE</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">);</span>

<span class="c1"># on &quot;grave&quot; le graphe dans celui ci</span>
<span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">burn</span><span class="p">())</span>

<span class="c1"># et on referme le fichier</span>
<span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>Là encore, les commentaires suffisent largement pour comprendre le tout.</p>
<p>Reste à rendre ledit script éxécutable et à le lancer :</p>
<div class="highlight"><pre><span></span>chmod u+x ./graph.py
./graph.py
</pre></div>
<p>Pour ceux qui veulent, le <a class="reference external" href="/static/images/dataporn/TGV.py">script est téléchargeable</a>.</p>
</div>
</div>
</div>
<div class="section" id="le-resultat-final">
<h2>Le résultat final</h2>
<p>Enfin, on observe le résultat (en <a class="reference external" href="/static/images/dataporn/ponct_TGV.svg">plus grand ici</a>)</p>
<object class="align-center" data="/static/images/dataporn/ponct_TGV.svg" style="width: 600px;" type="image/svg+xml">
</object>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>L'avantage de l'Opendata en termes d'interopérabilité est incontestable.
On arrive toutefois à un point où de plus en plus de données sont disponibles mais
difficilement compréhensibles car un peu trop <em>brutes</em>.</p>
<p>Heureusement, de très nombreux langages permettent de créer des représentations
graphiques beaucoup plus parlantes et ce presque sans difficultés.
Par exemple, ce script a été écrit en 5 minutes, juste pour tester.</p>
<p>Dans les mois et les années à venir, la maitrise d'outils permettant de
visualiser rapidement les implications d'un ensemble de données va devenir un
point critique tant dans ses applications économiques que dans l'aide qu'ils
représentent pour comprendre la société et ses évolutions.</p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>