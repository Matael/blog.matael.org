<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="python" />
		<meta name="tags" content="arduino" />
		<meta name="tags" content="dmx" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Un contrôleur DMX en python</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:39+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/arduino.html">arduino</a></li>
				<li><a href="/tag/dmx.html">dmx</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Cet article est une suite de l'article : <a class="reference external" href="http://blog.matael.org/writing/arduino-et-dmx/">Arduino et DMX</a>, il peut être bon de commencer par le début.</p>
<div class="section" id="resume-des-episodes-precedents">
<h2>Résumé des épisodes précédents</h2>
<p>Ayant acquis un projecteur LED avec une interface DMX 512, je me suis demandé si l'Arduino pouvait le contrôler.
Quelques tweets, un montage et un peu de code plus tard, ça fonctionnait.</p>
<p>Le problème suivant était de contrôler la bête depuis une application.</p>
</div>
<div class="section" id="choix-techniques-et-deroulement">
<h2>Choix techniques et déroulement</h2>
<div class="section" id="choix-techniques">
<h3>Choix Techniques</h3>
<p>Pour la création de l'application elle même, je me rabat sur python et la <em>toolbox</em> graphique <a class="reference external" href="http://wxpython.org/">wxPython</a>.</p>
<blockquote>
<p><strong>Note :</strong></p>
<p>Je ne vais pas détailler la création d'une appli wxPython (j'ai pas les connaissances pour ça, et ce n'est pas le
but). Je montrerais les quelques bouts de code utiles et fournirais le fichier complet à télécharger.</p>
</blockquote>
</div>
<div class="section" id="deroulement">
<h3>Déroulement</h3>
<p>L'article se présente comme suit :</p>
<ol class="arabic simple">
<li>Ré-écriture du code pour l'Arduino</li>
<li>Écriture de l'appli python</li>
<li>Lancement des deux et <em>&quot;oh, c'est beau !&quot;</em></li>
</ol>
</div>
</div>
<div class="section" id="arduino">
<h2>Arduino</h2>
<p>Au niveau du code Arduino, il va falloir tout ré-écrire.</p>
<p>On définira les 3 canaux associés aux 3 couleurs (R, G, B) en <tt class="docutils literal">#define</tt>.</p>
<p>La fonction <tt class="docutils literal">setup()</tt> passe les 3 canaux à 0 et initialise la connexion série tandis que la fonction <tt class="docutils literal">loop()</tt> remet
à jour les 3 couleurs si 3 octets au moins sont présents dans le <em>buffer</em> de la liaison :</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;DmxSimple.h&gt;</span><span class="cp"></span>
<span class="cp">#define CHAN_RED 1</span>
<span class="cp">#define CHAN_GREEN CHAN_RED+1</span>
<span class="cp">#define CHAN_BLUE CHAN_RED+2</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="c1">// On commence par passer tous les canaux à 0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DmxSimple</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// On initialise la connexion série</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DmxSimple</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">CHAN_RED</span><span class="p">,</span> <span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
        <span class="n">DmxSimple</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">CHAN_GREEN</span><span class="p">,</span> <span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
        <span class="n">DmxSimple</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">CHAN_BLUE</span><span class="p">,</span> <span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Alors, oui, les puristes diront que l'on pourrait économiser des lignes de code en utilisant 3 boucles seulement, il se
trouve que ça fonctionnement nettement moins bien.
Essayez si vous voulez ;)</p>
</div>
<div class="section" id="python">
<h2>Python !!</h2>
<p>Le code python est celui d'une appli <a class="reference external" href="http://wxpython.org/">wxPython</a> classique.</p>
<p>On crée d'abord la classe <tt class="docutils literal">DMXController</tt> qui sera notre base et on s'arrange pour coller à nos <em>&quot;specs&quot;</em>...</p>
<p>Tiens, d'ailleurs, qu'est ce qu'on veut qu'elle fasse cette appli ?</p>
<ul class="simple">
<li>il faudrait pouvoir contrôler chaque canal séparément (genre avec des sliders)</li>
<li>si on pouvait faire des flashes de couleur avec un bouton (comme sur les vraies consoles DMX) ce serait cool</li>
<li>deux/trois macros aideraient pas mal :<ul>
<li>BlackOut (tout éteint)</li>
<li>SpotLight (tout allumé)</li>
<li>Rouge</li>
<li>Vert</li>
<li>Bleu</li>
</ul>
</li>
<li>rechercher les ports série pouvant pointer vers un Arduino</li>
<li>permettre de sélectionner le port série voulu</li>
</ul>
<p>Le fichier final est <a class="reference external" href="/static/images/dmx/controller.py">disponible ici</a>, mais nous allons en détailler quelques points</p>
<div class="section" id="attention-a-la-version">
<h3>Attention à la version</h3>
<p>Attention, il vous faudra un <strong>python 2.7</strong> pour exécuter le code. En effet, celui ci utilise les dict comprehension qui
ne sont pas apparus avant...</p>
</div>
<div class="section" id="sliders">
<h3>Sliders</h3>
<p>Les lignes 37 à 67 du fichier instancient les sliders et les boutons pour les flashes.
D'abord un <em>sizer</em> horizontal pour y mettre les sliders (l.38) puis les sliders eux-même et le <tt class="docutils literal">Bind()</tt> qui va bien
(l.40 à l.46).</p>
<p>On boucle ensuite sur une liste de <em>tuples</em> contenant :</p>
<ul class="simple">
<li>une référence vers le slider</li>
<li>le nom à donner au bouton associé</li>
<li>une référence vers chacune des deux fonctions de <em>callback</em> pour les boutons (pressé et relâché)</li>
</ul>
<p>La boucle :</p>
<ol class="arabic simple">
<li>crée un <em>sizer</em> vertical pour le couple slider/bouton</li>
<li>ajoute le slider au <em>sizer</em></li>
<li>instancie le fameux bouton, l'ajoute à une liste puis le lie à ses deux <em>callback</em></li>
<li>ajoute le bouton au <em>sizer</em> vertical</li>
<li>ajoute le <em>sizer</em> vertical à celui horizontal créé plus haut</li>
</ol>
</div>
<div class="section" id="logger">
<h3>Logger</h3>
<p>La ligne 70 instancie une zone de texte en <em>read-only</em> pour pouvoir afficher nos messages à l'utilisateur
(particulièrement utile pendant le <em>debug</em>)...</p>
</div>
<div class="section" id="menu-ports">
<h3>Menu Ports</h3>
<p>On crée ensuite un menu pour les ports série.</p>
<p>On ajoute seulement l'entrée permettant de lancer la recherche de ports série, le menu lui même sera augmenté par la
fonction <tt class="docutils literal">DMXController.FindSerialPorts()</tt> un peu plus tard.</p>
</div>
<div class="section" id="menu-macros">
<h3>Menu Macros</h3>
<p>Les lignes 78 à 100 créent le menu pour les macros.
Chaque entrée est reliée à un <em>event handler</em> défini un peu plus bas.</p>
</div>
<div class="section" id="main-menu">
<h3>Main Menu</h3>
<p>On crée un menu principal qui ne contient que l'entrée pour quitter l'application (l.104 à l.107).</p>
<p>Les lignes 109 à 124 ajoutent chacun des éléments dans les bons <em>sizers</em> et créent les barres (menu et <em>statusbar</em>)
nécessaire au bon fonctionnement du tout.</p>
<p>Enfin on lance une détection de ports en ligne 127 avant d'afficher la fenêtre en ligne 130.</p>
</div>
<div class="section" id="methodes">
<h3>Méthodes</h3>
<p>Les méthodes sont plutot bien commentées.</p>
<p>Les plus intéressantes sont <tt class="docutils literal">FindSerialPorts</tt>, <tt class="docutils literal">SelectPort</tt> et <tt class="docutils literal">send_values</tt>.</p>
<p>J'aurais pu être plus propre que d'utiliser des fonctions de redirection pour les flashes et sliders, mais j'avoue que
sur le moment, j'ai pas pensé à faire autrement.</p>
</div>
</div>
<div class="section" id="en-action">
<h2>En action !</h2>
<p>C'est quand même le plus rigolo ;)</p>
<div class="section" id="id1">
<h3>Arduino</h3>
<p>Pour l'arduino, compilez et uploadez ça comme n'importe quel script (pour l'installation de la lib DMX, regardez du côté
de l'<a class="reference external" href="http://blog.matael.org/writing/arduino-et-dmx/">article précédent</a>).</p>
</div>
<div class="section" id="id2">
<h3>Python</h3>
<p>Il vous faudra installer au moins <strong>pyserial</strong> et <strong>wxpython</strong>, par exemple, pour une ubuntu ::</p>
<pre class="literal-block">
$ sudo apt-get install python-serial wxpython
</pre>
<p>devrait suffire, pour Arch ::</p>
<pre class="literal-block">
$ sudo pacman -S wxpython
$ sudo pip2 install pyserial
</pre>
<p>Sur Arch, ça installera aussi Python 2.7 si vous ne l'avez pas déjà.</p>
<img alt="" class="align-right" src="/static/images/dmx/controller.png" style="width: 300px;" />
<p>Finalement, on peut lancer l'application python via ::</p>
<pre class="literal-block">
$ chmod u+x controller.py
$ ./controller.py
</pre>
<p>Et vous aurez le rendu ci-contre.</p>
</div>
<div class="section" id="photos">
<h3>Photos</h3>
<p>Dans la foulée, j'ai aussi fait quelques photos que vous trouverez <a class="reference external" href="http://www.flickr.com/photos/matael/sets/72157631703520608/with/8060145746/">sur Flickr</a>.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Ce n'est pas du grand art, mais ce petit utilitaire a au moins l'avantage d'être simple à utiliser et pas trop complexe
à modifier.</p>
<p>Cela nous permet en outre de jouer plus facilement avec le projecteur.</p>
<p>Next step : une mini-app Android (probablement via SL4A).</p>
<p><strong>PS : Un dépot Github existe :</strong> <a class="reference external" href="https://github.com/Matael/PyDMXController">Matael/PyDMXController</a></p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>