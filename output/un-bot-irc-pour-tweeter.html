<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="perl" />
		<meta name="tags" content="irc" />
		<meta name="tags" content="bot" />
		<meta name="tags" content="twitter" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Un bot IRC pour tweeter</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:40+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/perl.html">perl</a></li>
				<li><a href="/tag/irc.html">irc</a></li>
				<li><a href="/tag/bot.html">bot</a></li>
				<li><a href="/tag/twitter.html">twitter</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Alors que le <a class="reference external" href="http://twitter.com/haum72">HAUM</a> vient de naître à proprement parler, les besoins de communiquer se sont fait sentir.</p>
<p>De leur côté, les gars de <a class="reference external" href="http://linuxmaine.org">LinuXMaine</a> ont créé un bout de wiki pour le tout nouveau hackerspace, un GoogleGroup (<em>sic</em>)
a permis de relier tout le monde par mail et enfin, un <em>chan</em> IRC a été mis en place.</p>
<div class="section" id="l-idee-de-depart">
<h2>L'idée de départ</h2>
<p>Finalement, l'idée de filer à tout le monde le mot de passe du compte twitter pour le HAUM me posait un léger soucis :</p>
<ul class="simple">
<li>risque de <em>leak</em> du mot de passe</li>
<li>problème de personne qui change le mot de passe</li>
<li>etc...</li>
</ul>
<p>L'idée était donc de créer un bot qui vive sur le chan IRC du HAUM et qui permette aux gens de <em>tweeter</em> au nom du
hackerspace. Enfin, il devait permettre de gérer facilement la liste des gens autorisés à poster et récuperer les
<em>mentions</em> pour les afficher sur le <em>chan</em>.</p>
</div>
<div class="section" id="l-organisation-du-code">
<h2>L'organisation du code</h2>
<p>Pour que le bot soit le plus hackable possible, j'ai choisi de faire un module Perl complet.</p>
<p>Le fichier ressemble donc à :</p>
<div class="highlight"><pre><span></span><span class="k">package</span> <span class="nn">TwitterBot</span><span class="p">;</span>

    <span class="c1"># import des modules</span>

    <span class="c1"># pour que le package soit un bot</span>
    <span class="k">use</span> <span class="nn">base</span> <span class="sx">qw( Bot::BasicBot )</span><span class="p">;</span>

    <span class="c1"># instructions...</span>

<span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="les-modules">
<h2>Les modules</h2>
<p>Plusieurs modules sont nécessaires pour ce bot, voilà les premières lignes du code (que vous pourrez aussi trouver sur
un <a class="reference external" href="https://github.com/haum/TwitterBot">dépot github</a>) :</p>
<div class="highlight"><pre><span></span><span class="c1"># classique</span>
<span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="mf">5.010</span><span class="p">;</span>

<span class="c1"># pour raccourcir les liens (cf le bonus ;))`</span>
<span class="k">use</span> <span class="nn">LWP::UserAgent</span><span class="p">;</span>

<span class="c1"># autres</span>
<span class="k">use</span> <span class="nn">Bot::BasicBot</span><span class="p">;</span>  <span class="c1"># c&#39;est un bot IRC</span>
<span class="k">use</span> <span class="nn">Net::Twitter</span><span class="p">;</span>   <span class="c1"># on a besoin de discuter avec l&#39;API Twitter</span>
<span class="k">use</span> <span class="nn">Redis</span><span class="p">;</span>                  <span class="c1"># pour gérer les permissions</span>
</pre></div>
<p>Les commentaires sont modifiés pour les besoins de l'article.</p>
<p>Plusieurs précisions :</p>
<ul class="simple">
<li>même si ce n'est pas forcément la meilleure manière de faire, j'utilise Redis pour gérer les permissions parce que
c'est globalement simple d'aller les modifier &quot;à la main&quot; (si le bot foire)</li>
<li>j'utilise le bout de code donné par <a class="reference external" href="http://ln-s.net">http://ln-s.net</a> pour raccourcir les liens, d'où l'utilisation de <tt class="docutils literal">LWP</tt></li>
</ul>
</div>
<div class="section" id="le-code-lui-meme">
<h2>Le code lui-même</h2>
<p>Le code peut se découper en 3 parties :</p>
<ul class="simple">
<li>l'envoi d'un <em>tweet</em></li>
<li>la gestion des permissions</li>
<li>la réduction des liens (aka, le bonus ;))</li>
<li>la récupération des <em>mentions</em></li>
</ul>
<p>On va les voir les unes après les autres.</p>
<p>Pour la gestion des messages qui arrivent, on définira la fonction <tt class="docutils literal">said()</tt>, comme le veux <tt class="docutils literal"><span class="pre">Bot::BasicBot</span></tt> :</p>
<div class="highlight"><pre><span></span><span class="k">sub</span> <span class="nf">said</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="c1"># twitter link</span>
    <span class="k">my</span> <span class="nv">$twlk</span> <span class="o">=</span> <span class="nn">Net::Twitter</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">traits</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw/OAuth API::REST/</span><span class="p">],</span>
        <span class="n">consumer_key</span>        <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">consumer_key</span><span class="p">},</span>
        <span class="n">consumer_secret</span>     <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">consumer_secret</span><span class="p">},</span>
        <span class="n">access_token</span>        <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">token</span><span class="p">},</span>
        <span class="n">access_token_secret</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">token_secret</span><span class="p">}</span>
    <span class="p">);</span>

    <span class="c1"># redis link</span>
    <span class="k">my</span> <span class="nv">$redis_db</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">redis_db</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$redis_pref</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">redis_pref</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$master</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">master</span><span class="p">};</span>

    <span class="k">my</span> <span class="nv">$rdb</span> <span class="o">=</span> <span class="nn">Redis</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
    <span class="nv">$rdb</span><span class="o">-&gt;</span><span class="nb">select</span><span class="p">(</span><span class="nv">$redis_db</span><span class="p">);</span>


    <span class="c1"># faire des trucs ici</span>

<span class="p">}</span>
</pre></div>
<div class="section" id="envoi-d-un-tweet">
<h3>Envoi d'un <em>tweet</em></h3>
<p>Pour envoyer un <em>tweet</em>, j'ai décidé de définir la commande <tt class="docutils literal">&#64;tweet truc à twitter</tt> dans le bot.</p>
<p>L'idée est simple :</p>
<ol class="arabic simple">
<li>on détecte la commande</li>
<li>on vérifie si la personne a le droit de poster</li>
<li>on vérifie que le futur <em>tweet</em> n'excède pas 140 caractères</li>
<li>on envoie le tweet</li>
<li>on affiche que tout s'est bien passé</li>
</ol>
<p>La gestion des erreurs n'a pas été prise en compte : il n'y en a pas vraiment besoin ici.</p>
<p>C'est parti pour le code :</p>
<div class="highlight"><pre><span></span><span class="c1"># si le message est de la forme /^@tweet un truc derrière$/...</span>
<span class="c1"># (on retient le truc derrière dans $1</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">body</span><span class="p">}</span> <span class="o">=~</span><span class="sr"> /^\@tweet (.+)$/</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1"># on vérifie si le poster est bien dans la DB des personnes autorisées</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$rdb</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$redis_pref</span><span class="o">.</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}))</span> <span class="p">{</span>

        <span class="c1"># on vérifie que la longueur n&#39;excède pas 140cars.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">140</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1"># si c&#39;est le cas, on le dit sur le chan et on affiche le nombre</span>
            <span class="c1"># de cars. du message.</span>
                            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                                    <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
                                    <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                                    <span class="n">body</span> <span class="o">=&gt;</span> <span class="s">&quot;Un peu long, &quot;</span><span class="o">.</span><span class="nb">length</span><span class="p">(</span><span class="nv">$1</span><span class="p">)</span><span class="o">.</span><span class="s">&quot; au lieu de 140...&quot;</span>
                            <span class="p">);</span>

            <span class="c1"># on quitte alors la fonction</span>
                            <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="c1"># mettre à jour le compte twitter...</span>
                    <span class="nv">$twlk</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">(</span><span class="nv">$1</span><span class="p">);</span>
                    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                            <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
                            <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                            <span class="n">body</span> <span class="o">=&gt;</span> <span class="s">&quot;C&#39;est parti !&quot;</span>
                    <span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>

            <span class="c1"># Si le posteur n&#39;est pas dans les nicks autorisés</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">#... on lui dit</span>
                    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                            <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
                            <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                            <span class="n">body</span> <span class="o">=&gt;</span> <span class="s">&quot;On se connait ?&quot;</span>
                    <span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
<p>Voilà pour ce qui permet de <em>tweeter</em>.</p>
</div>
<div class="section" id="gestion-des-permissions">
<h3>Gestion des permissions</h3>
<p>L'idée, c'est que le <em>&quot;maître&quot;</em> du bot soit capable d'ajouter ou de supprimer des gens d'une liste de posteurs
&quot;autorisés&quot;. Il faut que cette liste perdure même si le bot s'arrête.</p>
<p>Bien sûr, j'aurais pu utiliser <tt class="docutils literal">Storable</tt> ou un truc du genre (JSON ou YAML par exemple). J'ai choisi Redis parce que
j'ai un serveur Redis qui tourne et que je pourrais toujours conserver ma liste si je recode le bot en python par
exemple.</p>
<p>Finalement, j'aime pas toucher à des fichiers pour si peu et, comme utiliser Redis ne me demandait pas d'effort
particulier, j'ai pris ce que j'avais sous la main.</p>
<p>Le code est relativement simple :</p>
<div class="highlight"><pre><span></span>    <span class="c1"># ajouter quelqu&#39;un aux nicks autorisés</span>
<span class="c1"># commande : @allow nick</span>
    <span class="k">if</span> <span class="p">((</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}</span> <span class="ow">eq</span> <span class="nv">$master</span><span class="p">)</span> <span class="ow">and</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">body</span><span class="p">}</span> <span class="o">=~</span><span class="sr"> /\@allow (\w+)/</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1"># on ajoute le nick à la liste Redis</span>
            <span class="nv">$rdb</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="nv">$redis_pref</span><span class="o">.</span><span class="s">&#39;:&#39;</span><span class="o">.</span><span class="nv">$1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1"># on dit que tout va bien (parce que tout va toujours bien)</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                    <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$master</span><span class="p">,</span>
                    <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                    <span class="n">body</span> <span class="o">=&gt;</span> <span class="s">&quot;Ok ! $1 est maintenant dans la liste des twolls potentiels :3&quot;</span>
            <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1"># supprimer un nick de la liste</span>
<span class="c1"># commande : @disallow nick</span>
    <span class="k">if</span> <span class="p">((</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}</span> <span class="ow">eq</span> <span class="nv">$master</span><span class="p">)</span> <span class="ow">and</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">body</span><span class="p">}</span> <span class="o">=~</span><span class="sr"> /\@disallow (\w+)/</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1"># on le supprime (s&#39;il existait (pour éviter les erreurs, on vérifie)</span>
            <span class="nv">$rdb</span><span class="o">-&gt;</span><span class="n">del</span><span class="p">(</span><span class="nv">$redis_pref</span><span class="o">.</span><span class="s">&#39;:&#39;</span><span class="o">.</span><span class="nv">$1</span><span class="p">)</span> <span class="k">if</span> <span class="nv">$rdb</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$redis_pref</span><span class="o">.</span><span class="nv">$1</span><span class="p">);</span>

    <span class="c1"># on dit que tout va bien ;)</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                    <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$master</span><span class="p">,</span>
                    <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                    <span class="n">body</span> <span class="o">=&gt;</span> <span class="s">&quot;Adieu $1, je l&#39;aimais bien&quot;</span>
            <span class="p">);</span>
    <span class="p">}</span>
</pre></div>
<p>Et plouf ! Ça, c'est fait.</p>
</div>
</div>
<div class="section" id="reduire-les-liens">
<h2>Réduire les liens</h2>
<p>Je vous met le bout de code tel quel mais il vient tout droit de <a class="reference external" href="http://ln-s.net">http://ln-s.net</a> :</p>
<div class="highlight"><pre><span></span><span class="c1"># shrink links</span>
<span class="c1"># partly form ln-s.net ;) thanks to them</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">body</span><span class="p">}</span> <span class="o">=~</span><span class="sr"> /^\@shrink (.+)$/</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$rdb</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$redis_pref</span><span class="o">.</span><span class="s">&#39;:&#39;</span><span class="o">.</span><span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">}))</span> <span class="p">{</span>
                <span class="c1"># set up the LWP User Agent and create the request</span>
                <span class="k">my</span> <span class="nv">$userAgent</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">LWP::</span><span class="n">UserAgent</span><span class="p">;</span>
                <span class="k">my</span> <span class="nv">$request</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">HTTP::</span><span class="n">Request</span> <span class="n">POST</span> <span class="o">=&gt;</span> <span class="s">&#39;http://ln-s.net/home/api.jsp&#39;</span><span class="p">;</span>
                <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">(</span><span class="s">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">);</span>

                <span class="c1"># encode the URL and add it to the url parameter in the request</span>
                <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
                <span class="nv">$url</span> <span class="o">=</span> <span class="nn">URI::Escape::</span><span class="n">uri_escape</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
                <span class="nv">$request</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">(</span><span class="s">&quot;url=$url&quot;</span><span class="p">);</span>

                <span class="c1"># make the request</span>
                <span class="k">my</span> <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$userAgent</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

                <span class="c1"># handle the response</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="n">is_success</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">my</span> <span class="nv">$reply</span> <span class="o">=</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="n">content</span><span class="p">;</span>
                        <span class="mi">1</span> <span class="k">while</span><span class="p">(</span><span class="nb">chomp</span><span class="p">(</span><span class="nv">$reply</span><span class="p">));</span>
                        <span class="k">my</span> <span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="nv">$message</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">,</span><span class="nv">$reply</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                                <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
                                <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                                <span class="n">body</span> <span class="o">=&gt;</span> <span class="nv">$message</span>
                        <span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">my</span> <span class="p">(</span><span class="nv">$status</span><span class="p">,</span> <span class="nv">$message</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">,</span><span class="nv">$response</span><span class="o">-&gt;</span><span class="n">status_line</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                        <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                                <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
                                <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                                <span class="n">body</span> <span class="o">=&gt;</span> <span class="s">&quot;Erf... Statut : $status =&gt; $message&quot;</span>
                        <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                        <span class="n">who</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">who</span><span class="p">},</span>
                        <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$msg</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channel</span><span class="p">},</span>
                        <span class="n">body</span> <span class="o">=&gt;</span> <span class="s">&quot;On se connait ?&quot;</span>
                <span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="section" id="recuperer-les-mentions">
<h3>Récupérer les <em>mentions</em></h3>
<p>L'idée là encore c'est que tout le monde puisse voir les mentions qui arrivent.</p>
<p>Vous allez voir, c'est trivial.
Le seul petit point vicieux, c'est qu'il faut retenir l'<strong>ID</strong> de la dernière <em>mention</em>.</p>
<p>On utilise la fonction <tt class="docutils literal">tick()</tt> de <tt class="docutils literal"><span class="pre">Bot::BasicBot</span></tt> qui permet d'éxécuter une action périodiquement. Le temps (en
secondes) entre deux &quot;tick&quot; est donné par le nombre de retour de la fonction.</p>
<p>Le code se comprend bien une fois commenté :</p>
<div class="highlight"><pre><span></span><span class="c1"># on vérifie twitter toutes les 5 minutes pour ne pas surcharger l&#39;API</span>
<span class="k">sub</span> <span class="nf">tick</span> <span class="p">{</span>
    <span class="k">my</span> <span class="p">(</span><span class="nv">$self</span><span class="p">)</span> <span class="o">=</span> <span class="nv">@_</span><span class="p">;</span>

    <span class="c1"># twitter link</span>
    <span class="k">my</span> <span class="nv">$twlk</span> <span class="o">=</span> <span class="nn">Net::Twitter</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span>
        <span class="n">traits</span>   <span class="o">=&gt;</span> <span class="p">[</span><span class="sx">qw/OAuth API::REST/</span><span class="p">],</span>
        <span class="n">consumer_key</span>        <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">consumer_key</span><span class="p">},</span>
        <span class="n">consumer_secret</span>     <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">consumer_secret</span><span class="p">},</span>
        <span class="n">access_token</span>        <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">token</span><span class="p">},</span>
        <span class="n">access_token_secret</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">token_secret</span><span class="p">}</span>
    <span class="p">);</span>

    <span class="c1"># redis link</span>
    <span class="k">my</span> <span class="nv">$redis_db</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">redis_db</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$redis_pref</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">redis_pref</span><span class="p">};</span>
    <span class="k">my</span> <span class="nv">$master</span> <span class="o">=</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">master</span><span class="p">};</span>

    <span class="k">my</span> <span class="nv">$rdb</span> <span class="o">=</span> <span class="nn">Redis</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">();</span>
    <span class="nv">$rdb</span><span class="o">-&gt;</span><span class="nb">select</span><span class="p">(</span><span class="nv">$redis_db</span><span class="p">);</span>

    <span class="c1"># récupérer l&#39;ID du dernier tweet</span>
    <span class="k">my</span> <span class="nv">$last</span> <span class="o">=</span> <span class="nv">$rdb</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="nv">$redis_pref</span><span class="o">.</span><span class="s">&quot;:last_twid&quot;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@statuses</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$last</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># si on en trouve pas, on récupère tout (et on laissse l&#39;API gérer)</span>
        <span class="nv">@statuses</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$twlk</span><span class="o">-&gt;</span><span class="n">mentions</span><span class="p">()};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1"># sinon, on utilise le paramètre since_id de</span>
        <span class="c1"># Net::Twitter-&gt;mention() pour filtrer</span>
        <span class="nv">@statuses</span> <span class="o">=</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$twlk</span><span class="o">-&gt;</span><span class="n">mentions</span><span class="p">({</span><span class="n">since_id</span> <span class="o">=&gt;</span> <span class="nv">$last</span><span class="p">})};</span>
    <span class="p">}</span>


    <span class="c1"># On envoie chaque tweet sur le canal</span>
    <span class="c1"># y&#39;a un offset de 1 pour ne pas tomber dans les limites</span>
    <span class="c1"># des valeurs de retour de l&#39;API twitter</span>
    <span class="k">my</span> <span class="nv">$len</span> <span class="o">=</span> <span class="nb">scalar</span><span class="p">(</span><span class="nv">@statuses</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$status</span><span class="p">;</span>
        <span class="k">my</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$len</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">say</span><span class="p">(</span>
                    <span class="n">channel</span> <span class="o">=&gt;</span> <span class="nv">$self</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">channels</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">body</span> <span class="o">=&gt;</span> <span class="nv">$statuses</span><span class="p">[</span><span class="nv">$len</span><span class="o">-</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">user</span><span class="p">}</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">screen_name</span><span class="p">}</span><span class="o">.</span>
                        <span class="s">&quot; =&gt; &quot;</span><span class="o">.</span><span class="nv">$statuses</span><span class="p">[</span><span class="nv">$len</span><span class="o">-</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">text</span><span class="p">}</span>
            <span class="p">);</span>
            <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$rdb</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="nv">$redis_pref</span><span class="o">.</span><span class="s">&quot;:last_twid&quot;</span><span class="p">,</span> <span class="nv">$statuses</span><span class="p">[</span><span class="nv">$len</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="nv">$i</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">id</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="c1"># &quot;dormir&quot; 5 min ;)</span>
    <span class="k">return</span> <span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Et voilà pour ça !</p>
<p>En fait, ça produit un retour de la forme :</p>
<blockquote>
celui qui a twitté =&gt; le tweet lui même</blockquote>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>L'idée derrière cet artcile n'était pas de faire un tuto complet mais plutôt de dérouler un peu le code d'un bot
permettant de lier twitter et IRC. Il en existe des dixaines d'autres.</p>
<p>Il y avait forcément d'autres moyens de le faire (vous vous souvenez ? <strong>TIMTOWTDI</strong>), des plus propres, des plus
efficaces, des moins beaux, etc...</p>
<p>L'objectif, c'était clairement de fournir un programme pour combler un besoin. Il ne fallait pas forcément que ça soit
beau, mais seulement que ça marche.</p>
<p>Hackez ça comme vous le voudrez ! (<strong>WTFPL ftw !</strong>).</p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>