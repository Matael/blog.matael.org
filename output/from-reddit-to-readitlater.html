<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="reddit" />
		<meta name="tags" content="perl" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>From Reddit To ReadItLater</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:27:47+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/reddit.html">reddit</a></li>
				<li><a href="/tag/perl.html">perl</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Hi !
First attempt to write a whole article in english on this blog.
As I'm not a native speaker, some of my sentences could sounds a bit strange, please forgive ... or better : let me know ;)</p>
<p>A few months ago, a friend told me about <a class="reference external" href="http://reddit.com">reddit</a>.
This had been a great discovery for me, and I started using it (a lot).
On reddit, I spend most of my time lurking.</p>
<div class="section" id="idea">
<h2>Idea</h2>
<p>During a discussion, it appears that it could be nice to have a script crawling <a class="reference external" href="http://reddit.com">reddit</a> and (matching titles against some pre-defined keywords) adding interesting links to a ReadItLater list.</p>
<p>As I have an android phone with the RIL application installed, this is great !</p>
<p><a class="reference external" href="http://readitlater.com">RIL</a> has just been renamed <a class="reference external" href="http://getpocket.com/">Pocket</a> but the principle stay unchanged :</p>
<ol class="arabic simple">
<li>append URLs to your <em>Reading List</em></li>
<li>Sync between several devices</li>
<li>enjoy articles o/</li>
</ol>
<div class="section" id="connection-to-reddit">
<h3>Connection to reddit</h3>
<p>As I already knew RIL powers an <a class="reference external" href="http://getpocket.com/api">API</a>, I had just to find a way to fetch reddit posts.</p>
<p>The easiest way I thought about was to find a generic RSS feed URL and then re-use it.</p>
<p>As I had already seen some reddit applets on websites, I was pretty sure such a thing existed.</p>
<p>I looked at the reddit <a class="reference external" href="http://reddit.com/widget">gadgets page</a> and found that we can fetch JS code adding <tt class="docutils literal">/.embed</tt> to a subreddit URL.
As a naive guy, I tried <a class="reference external" href="http://reddit.com/r/vim/new/.rss&amp;limit=5&amp;t=all&amp;sort=new">http://reddit.com/r/vim/new/.rss&amp;limit=5&amp;t=all&amp;sort=new</a> . And guess what happened...
I got a beautiful RSS feed <strong>o/</strong>.</p>
<p><strong>Note :</strong> The parameters in the URL come from the gadgets page-generated urls.</p>
<p>After a very very short poll, I chose to build the script in perl, for several reasons :</p>
<ul class="simple">
<li>it has a lot of modules with funny names (<tt class="docutils literal"><span class="pre">File::Slurp</span></tt> for example ;))</li>
<li>it's installed basically on every Linux system</li>
<li>installing a new module is easy</li>
<li>perl is cool</li>
</ul>
<div class="section" id="modules">
<h4>Modules</h4>
<p>So, I choose perl and the following modules :</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">XML::RSS:Parser::Lite</span></tt> : to parse the feed itself</li>
<li><tt class="docutils literal"><span class="pre">XML::Parser::Lite</span></tt> : required by the first one</li>
<li><tt class="docutils literal"><span class="pre">Text::Match::FastAlternatives</span></tt> : to create easily a <em>regex</em> (not a real one) with searched words</li>
<li><tt class="docutils literal">YAML</tt> : to parse config file</li>
<li><tt class="docutils literal"><span class="pre">File::Slurp</span></tt> : to read an entire file (yeah, this name is great)</li>
</ul>
<p>All these modules are on <a class="reference external" href="http://www.cpan.org">CPAN</a> and installable using :</p>
<div class="highlight"><pre><span></span>sudo cpan Module::Name
</pre></div>
<p>As I'm a nice guy (uh uh...), I also wrote a <tt class="docutils literal">Makefile</tt> with a <tt class="docutils literal">deps</tt> target to install everything using :</p>
<div class="highlight"><pre><span></span>make deps
</pre></div>
<p>As I wanted to keep the main script clean, I chose to build a module myself containing the functions I need.</p>
<p>So... I called it <tt class="docutils literal">RedditRIL.pm</tt> and just added the minimum code :</p>
<div class="highlight"><pre><span></span><span class="k">package</span> <span class="nn">RedditRIL</span><span class="p">;</span>
    <span class="c1"># .. here will go my code ...</span>
<span class="mi">1</span><span class="p">;</span> <span class="c1"># because a package must end with a true expression</span>
</pre></div>
<p>In the first version of this script, I put curly-braces between this to lines of code.
Someone told me (on reddit) that it's not necessary : a package create automatically a new namespace.</p>
</div>
</div>
<div class="section" id="parse-config">
<h3>Parse config</h3>
<p>The goal is to use a config file looking like :</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">credentials</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">login</span><span class="p p-Indicator">,</span> <span class="nv">pass</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">Python</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">Internet</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">vim</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">unmapping</span><span class="p p-Indicator">,</span><span class="nv">path</span><span class="p p-Indicator">]</span>
</pre></div>
<p>Using <tt class="docutils literal"><span class="pre">File::Slurp</span></tt> and <tt class="docutils literal">YAML</tt>, we can get all the data :</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env perl</span>

<span class="c1"># this is not the module, but the script ;)</span>

<span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
<span class="k">use</span> <span class="mf">5.010</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">YAML</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">File::Slurp</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span><span class="n">read_file</span><span class="p">(</span><span class="s">&quot;./RedditRIL.conf&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="p">(</span><span class="s">&quot;Error with conf. file $!&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$conf</span> <span class="o">=</span> <span class="n">Load</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">$credentials</span> <span class="o">=</span> <span class="nv">$conf</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">credentials</span><span class="p">};</span>
</pre></div>
<p>So now, we have login information for <a class="reference external" href="http://readitlater.com">RIL</a> in <tt class="docutils literal">$credentials</tt> and whole conf in <tt class="docutils literal">$conf</tt>.</p>
<p>Of course, the script will need to <em>know</em> this information (particularily the credentials).</p>
<p>Let's add a <tt class="docutils literal">new()</tt> method to our package :</p>
<div class="highlight"><pre><span></span><span class="c1"># some atributes</span>
    <span class="k">my</span> <span class="nv">$ril_api_key</span> <span class="o">=</span> <span class="s">&quot;my_api_key&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ril_login</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ril_pass</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$ril_url</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="c1"># And the new() method</span>
    <span class="k">sub</span> <span class="nf">new</span> <span class="p">{</span>
            <span class="k">my</span> <span class="nv">$self</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
            <span class="nv">$ril_login</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
            <span class="nv">$ril_pass</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
            <span class="nv">$ril_url</span> <span class="o">=</span> <span class="s">&quot;https://readitlaterlist.com/v2/add?username=$ril_login&amp;password=$ril_pass&amp;apikey=$ril_api_key&quot;</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$self</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
<p>Note that the API Key can be requested on the page dedicated to the <a class="reference external" href="http://getpocket.com/api">API</a> itself.</p>
<p>We can now create a new RedditRIL object in the script using :</p>
<div class="highlight"><pre><span></span><span class="k">use</span> <span class="nn">RedditRIL</span><span class="p">;</span>

<span class="c1"># ...</span>

<span class="k">my</span> <span class="nv">$api</span> <span class="o">=</span> <span class="nn">RedditRIL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">@</span><span class="p">{</span><span class="nv">$credentials</span><span class="p">}[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">@</span><span class="p">{</span><span class="nv">$credentials</span><span class="p">}[</span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
<p>And iterate over data from config file, processing subreddits one by one :</p>
<div class="highlight"><pre><span></span><span class="k">foreach</span> <span class="k">my</span> <span class="nv">$key</span> <span class="p">(</span><span class="nb">keys</span> <span class="nv">%</span><span class="p">{</span><span class="nv">$conf</span><span class="p">})</span> <span class="p">{</span>
    <span class="k">next</span> <span class="k">if</span> <span class="nv">$key</span> <span class="ow">eq</span> <span class="s">&quot;credentials&quot;</span><span class="p">;</span>
    <span class="nv">$api</span><span class="o">-&gt;</span><span class="n">process</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$conf</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$key</span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>I think you understood that we'll now write the <tt class="docutils literal">process()</tt> method which will be passed :</p>
<ul class="simple">
<li>a reference to the object itself (implicit)</li>
<li>the name of a subreddit (<tt class="docutils literal">$key</tt>)</li>
<li>the keywords to look for in this subreddit (array reference <tt class="docutils literal"><span class="pre">$conf-&gt;{$key}</span></tt></li>
</ul>
</div>
<div class="section" id="processing-a-reddit">
<h3>Processing a reddit</h3>
<div class="highlight"><pre><span></span>package RedditRIL<span class="p">;</span>
<span class="o">{</span>
    use strict<span class="p">;</span>
    use warnings<span class="p">;</span>
    use <span class="m">5</span>.010<span class="p">;</span>
    use LWP::Simple<span class="p">;</span>
    use XML::RSS::Parser::Lite<span class="p">;</span>
    use Text::Match::FastAlternatives<span class="p">;</span>

    <span class="c1"># new() + attributes</span>

    sub process <span class="o">{</span>
        <span class="c1"># Process a subreddit,</span>
        <span class="c1"># Get a subreddit name &amp; keywords</span>
        <span class="c1"># as argument</span>
        my <span class="o">(</span><span class="nv">$self</span>, <span class="nv">$sub</span>, <span class="nv">$kws</span><span class="o">)</span> <span class="o">=</span> @_<span class="p">;</span>
        my <span class="nv">$data</span> <span class="o">=</span> XML::RSS::Parser::Lite-&gt;new<span class="o">()</span><span class="p">;</span>
        <span class="nv">$data</span>-&gt;parse<span class="o">(</span>get<span class="o">(</span><span class="s2">&quot;http://www.reddit.com/r/</span><span class="nv">$sub</span><span class="s2">/new/.rss?limit=5&amp;t=all&amp;sort=new&quot;</span><span class="o">))</span> or die <span class="o">(</span><span class="s2">&quot;Erf.. a error occured :\n\t</span><span class="nv">$!</span><span class="s2">&quot;</span><span class="o">)</span><span class="p">;</span>
        my <span class="nv">$re</span>  <span class="o">=</span> join <span class="s2">&quot;|&quot;</span>, @<span class="o">{</span><span class="nv">$kws</span><span class="o">}</span><span class="p">;</span>
        <span class="k">for</span> <span class="o">(</span>my <span class="nv">$i</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span> <span class="nv">$i</span> &lt; <span class="nv">$data</span>-&gt;count<span class="o">()</span><span class="p">;</span> <span class="nv">$i</span>++<span class="o">)</span> <span class="o">{</span>
            my <span class="nv">$item</span> <span class="o">=</span> <span class="nv">$data</span>-&gt;get<span class="o">(</span><span class="nv">$i</span><span class="o">)</span><span class="p">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="nv">$item</span>-&gt;<span class="o">{</span>title<span class="o">}</span> <span class="o">=</span>~ <span class="nv">$re</span><span class="o">)</span> <span class="o">{</span>
                <span class="nv">$self</span>-&gt;add_to_ril<span class="o">(</span><span class="nv">$item</span><span class="o">)</span><span class="p">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>The first line of <tt class="docutils literal">process()</tt> (right after comments) fetches values passed as arguments :</p>
<ul class="simple">
<li><tt class="docutils literal">$sub</tt> will contain the subreddit name</li>
<li><tt class="docutils literal">$kws</tt> is for the list of searched keywords</li>
</ul>
<p>The second one just initialize a RSS Parser whom <tt class="docutils literal">parse()</tt> method is used on the following line.</p>
<p>For this method, we send an URL containing the <tt class="docutils literal">$sub</tt> variable (it will be interpolated on evaluation).</p>
<p>The <tt class="docutils literal">die</tt> clause stops the script if an error occured, printing the error (<tt class="docutils literal">$!</tt>) on screen.</p>
<p>Next, we create a simple search <strong>false</strong> <em>regex</em> using <tt class="docutils literal"><span class="pre">Text::Match::FastAlternatives</span></tt> (here with <tt class="docutils literal">join</tt>).</p>
<p>The the script loops over each item of the freshly parsed feed and tests it against the <em>regex</em>.</p>
<p>If it matches, we send the item itself to another method : <tt class="docutils literal">add_to_ril()</tt>.</p>
</div>
<div class="section" id="send-it-to-ril">
<h3>Send it to RIL</h3>
<p>This method simply uses the RIL <a class="reference external" href="http://getpocket.com/api">API</a> through its <tt class="docutils literal">add</tt> method :</p>
<div class="highlight"><pre><span></span>sub add_to_ril <span class="o">{</span>
        my <span class="o">(</span><span class="nv">$self</span>,<span class="nv">$item</span><span class="o">)</span>  <span class="o">=</span> @_<span class="p">;</span>
        say <span class="s2">&quot;+ Adding link </span><span class="nv">$item</span><span class="s2">-&gt;{url}&quot;</span><span class="p">;</span>
        get<span class="o">(</span><span class="s2">&quot;</span><span class="nv">$ril_url</span><span class="s2">&amp;url=</span><span class="nv">$item</span><span class="s2">-&gt;{url}&amp;title=</span><span class="nv">$item</span><span class="s2">-&gt;{title}&quot;</span><span class="o">)</span>
    or die <span class="o">(</span><span class="s2">&quot;Unable to upload link to RIL...\n\t</span><span class="nv">$!</span><span class="s2">&quot;</span><span class="o">)</span><span class="p">;</span>
say<span class="o">(</span><span class="s2">&quot;\t=&gt; Done uploading !&quot;</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</pre></div>
<p>A small reminding prints on screen saying which link we're sending to <a class="reference external" href="http://readitlater.com">RIL</a>.</p>
<p>Then, a simple <tt class="docutils literal">get</tt> request sends the link itself to RIL, with the title specified on <a class="reference external" href="http://reddit.com">reddit</a>.</p>
</div>
</div>
<div class="section" id="testing">
<h2>Testing</h2>
<p>We can now fill the <tt class="docutils literal">RedditRIL.conf</tt> file, run the script and see this :</p>
<div class="highlight"><pre><span></span>$ ./crawler.pl
+ Adding link http://www.reddit.com/r/vim/comments/su21k/map_jj_to_what_exiting_input_mode_but_then/
        <span class="o">=</span>&gt; Done uploading !uploading
</pre></div>
<p>It works ! Great !</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>We are now able to add automatically interesting <a class="reference external" href="http://reddit.com">reddit</a> links to our <a class="reference external" href="http://readitlater.com">RIL</a> account.</p>
<p>This sounds nice but we can do even more interesting things. One idea could be the following :</p>
<blockquote>
<p>A script crawls RSS of selected subreddits (specified in the config file), searching for specified keywords.
This script adds potentialy interesting links to a Redis database.</p>
<p>Another provides a minimalist web or cli frontend to this DB allowing the user to up/down vote selectioned links.</p>
<p>The crawler can change his critera a bit to be more accurate next time according to user's votes.</p>
<p>A third script takes every link in DB from time to time and sends them to RIL (using <tt class="docutils literal">send</tt> method for example).</p>
</blockquote>
<p>Note that this system can be oriented to feed a (redis) pub/sub channel with a feedback ability.</p>
<p>Maybe I'll improve it....</p>
<p>Here's where you'll find the whole project :</p>
<blockquote>
<a class="reference external" href="https://github.com/Matael/reddit_doors">https://github.com/Matael/reddit_doors</a></blockquote>
</div>
<div class="section" id="note">
<h2>Note</h2>
<p>I just want to thank :</p>
<ul class="simple">
<li>my english teacher for her careful reading and corrections to this article</li>
<li><a class="reference external" href="https://github.com/ronocdh">ronocdh</a> for his improvements to my code</li>
</ul>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>