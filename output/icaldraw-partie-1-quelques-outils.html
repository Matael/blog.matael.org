<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="ical" />
		<meta name="tags" content="python" />
		<meta name="tags" content="svg" />
		<meta name="tags" content="fac" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>IcalDraw (Partie 1) : Quelques outils</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:41+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/ical.html">ical</a></li>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/svg.html">svg</a></li>
				<li><a href="/tag/fac.html">fac</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Il y a quelques jours, je me suis rendu compte que l'emploi du temps de cette année serait un peu complexe.
Par &quot;un peu complexe&quot;, j'entends qu'entre la connexion à l'ENT et l'affichage de l'emploi du temps correct s'étend un
concert de clics pour sélectionnner les bons groupes, les bonnes options et tout le reste. Pour moi qui suis allergique à la
souris, ça ne pouvait pas le faire....</p>
<p>On va donc essayer de partir de l'API d'export d'emploi du temps (comme dans <a class="reference external" href="/writing/passer-de-lical-au-pdf-un-petit-script/">cet article</a>) pour aboutir à une image
SVG dépouillée de l'inutile avec juste les cours de notés dessus sous forme de lignes temporelles.</p>
<p>Un exemple pour mieux comprendre :</p>
<img alt="" class="align-center" src="/static/images/icaldraw/exemple.png" style="width: 800px;" />
<p>Dans l'ordre, voilà les étapes :</p>
<ul class="simple">
<li>créer quelques outils pour rendre le script final plus simple :<ul>
<li>un moyen de récupérer facilement les événements Ical depuis une URL/un fichier</li>
<li>un moyen de créer des fichiers SVG et d'y ajouter des éléments <a class="footnote-reference" href="#id3" id="id1">[1]</a></li>
</ul>
</li>
<li>écrire le programme lui même permettant la génération des images</li>
<li>écrire un script l'utilisant</li>
</ul>
<div class="section" id="recuperation-des-evenements-ical">
<h2>Récupération des évenements Ical</h2>
<p>Rien de nouveau ici (tout a été traité dans <a class="reference external" href="/writing/passer-de-lical-au-pdf-un-petit-script/">cet article</a>).</p>
<p>On va se contenter d'écrire un <em>wrapper</em> agréable à utiliser pour simplifier le code final.</p>
<p>On reprend donc le code désormais connu pour en faire un module. Les commentaires devraient suffir à sa compréhension.
Pour quelque chose de plus détaillé, reportez vous à l'article sus-cité.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">icalendar</span> <span class="kn">import</span> <span class="n">Calendar</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">urlopen</span>

<span class="c1"># Structure de donnée pour les évènements</span>
<span class="n">Vevent</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Vevent&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dtstart&#39;</span><span class="p">,</span> <span class="s1">&#39;dtend&#39;</span><span class="p">,</span> <span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">IcalFetcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetcher for Ical data.</span>
<span class="sd">    Provides a wrapper to get clean, sorted list of events</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># init. all to None, this way we can infer which source to use</span>
        <span class="c1"># if user doesn&#39;t specify it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add URL source and change mode to URL &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;URL&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add file source and change mode to FILE &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;FILE&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add __iter__ special method so we can iterate directly over the object &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ev</span>


    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Grab list of events and sort them. Source is selected through mode &quot;&quot;&quot;</span>

        <span class="c1"># find which source to use (if no mode&#39;s specified on call, use self.mode)</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;FILE&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
            <span class="c1"># read data from file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">gcal</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="n">from_ical</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;URL&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="o">!=</span><span class="bp">None</span><span class="p">:</span>
            <span class="c1"># open url and read data from it</span>
            <span class="n">gcal</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="n">from_ical</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if mode&#39;s unknown, just raise an Exception</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supplied mode is not correct. Accepted modes are : FILE, URL&quot;</span><span class="p">)</span>

        <span class="c1"># clean and sort events</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">gcal</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">component</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;VEVENT&quot;</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">Vevent</span><span class="p">(</span><span class="n">dtstart</span><span class="o">=</span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtstart&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                           <span class="n">dtend</span><span class="o">=</span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dtend&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                           <span class="n">summary</span><span class="o">=</span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">),</span>
                           <span class="n">location</span><span class="o">=</span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
                          <span class="p">)</span>
                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">ev</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">dtstart</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span>  <span class="n">events</span>
</pre></div>
<p>Nous avons désormais un outil <em>iterable</em> qui contiendra les événements triés.</p>
</div>
<div class="section" id="naissance-d-un-svg">
<h2>Naissance d'un SVG</h2>
<div class="section" id="rappel-sur-le-format">
<h3>Rappel sur le format</h3>
<p>SVG est un format dérivé du XML.</p>
<p>Il comprend donc une entête suivie de balise indiquant les éléments à afficher et les données s'y rapportant :
coordonnées, contenu, style, etc...</p>
<p>On peut ajouter des élément de style soit via une feuille CSS liée, soit directement par l'attribut <tt class="docutils literal">style</tt> des balises
XML (ce que nous ferons ici).</p>
<p>Finalement, le tout est placer dans un fichier <tt class="docutils literal">.svg</tt> qui est en fait un fichier texte bête et méchant.</p>
<p>Une chose à savoir, SVG ne supporte pas les &lt;, &gt; et autres &amp; en dehors des balises, le fichier est alors considéré
incorect et rien ne s'affiche.</p>
</div>
<div class="section" id="code">
<h3>Code</h3>
<p>Il existe des modules pour faire du SVG en Python, mais pour l'utilisation que l'on va en faire, autant en refaire un
qui soit taillé parfaitement pour le boulot.</p>
<p>On va avoir besoin d'ajouter quelques éléments de base :</p>
<ul class="simple">
<li>des lignes</li>
<li>des cercles</li>
<li>du texte</li>
<li>des rectangles <a class="footnote-reference" href="#id4" id="id2">[2]</a></li>
</ul>
<p>C'est parti, la classe s'appellera <tt class="docutils literal">SVGwriter</tt> (quelle surprise) :</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SVGwriter</span><span class="p">:</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We do not remember title and desc &#39;cause we won&#39;t need them anymore after header</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span>

        <span class="c1"># output buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">([</span>
            <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;{0}&quot; height=&quot;{1}&quot;&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
            <span class="s1">&#39;&lt;title&gt;{0}&lt;/title&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">),</span>
            <span class="s1">&#39;&lt;desc&gt;{0}&lt;/desc&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
        <span class="p">])</span>
</pre></div>
<p>On va aussi ajouter à la classe un point de sortie. Plutot qu'écrire directement dans le fichier, on va coller les ligne
en tampon les unes après les autres puis la méthode <tt class="docutils literal">save()</tt> les écrira vraiment.
La méthode <tt class="docutils literal">_out()</tt> est une méthode privée qui sert de point de sortie.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Append a line or a list of lines to the output buffer &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Save self.lines to filename &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s2">&quot;&lt;/svg&gt;&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
<p>Ajoutons maintenant les éléments de base.</p>
</div>
<div class="section" id="rectangle">
<h3>Rectangle</h3>
<p>La recette ressemble à ça</p>
<pre class="literal-block">
&lt;rect width=&quot;LARGEUR&quot; height=&quot;HAUTEUR&quot; x=&quot;ABSCISSE ORIGINE&quot; y=&quot;ORDONNEE ORIGINE&quot; [style=&quot;STYLE&quot;] /&gt;
</pre>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Rectangle &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;rect width=&quot;{0}&quot; height=&quot;{1}&quot; x=&quot;{2}&quot; y=&quot;{3}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;rect width=&quot;{0}&quot; height=&quot;{1}&quot; x=&quot;{2}&quot; y=&quot;{3}&quot; style=&quot;{4}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>
</pre></div>
<p>Et ce sera semblable pour les 3 autres</p>
</div>
<div class="section" id="cercle">
<h3>Cercle</h3>
<p>On veut ce genre de sortie</p>
<pre class="literal-block">
&lt;circle cx=&quot;ABSCISSE CENTRE&quot; cy=&quot;ORDONNEE CENTRE&quot; r=&quot;RAYON&quot; [style=&quot;STYLE&quot;] /&gt;
</pre>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Circle &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;circle cx=&quot;{0}&quot; cy=&quot;{1}&quot; r=&quot;{2}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;circle cx=&quot;{0}&quot; cy=&quot;{1}&quot; r=&quot;{2}&quot; style=&quot;{3}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="ligne">
<h3>Ligne</h3>
<p>Cette fois, on veut ça</p>
<pre class="literal-block">
&lt;line x1=&quot;ABSCISSE DEBUT&quot; y1=&quot;ORDONNEE DEBUT&quot; x2=&quot;ABSCISSE FIN&quot; y2=&quot;ORDONNEE FIN&quot; [style=&quot;STYLE&quot;] /&gt;
</pre>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Line &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;line x1=&quot;{0}&quot; y1=&quot;{1}&quot; x2=&quot;{2}&quot; y2=&quot;{3}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;line x1=&quot;{0}&quot; y1=&quot;{1}&quot; x2=&quot;{2}&quot; y2=&quot;{3}&quot; style=&quot;{4}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="texte">
<h3>Texte</h3>
<p>Enfin, il nous faut ça</p>
<pre class="literal-block">
&lt;text x=&quot;ABSCISSE&quot; y=&quot;ORDONNEE&quot; [style=&quot;STYLE&quot;]&gt;TEXTE&lt;/text&gt;
</pre>
<p>Attention, le texte doit être nettoyé, d'où le <tt class="docutils literal">replace()</tt> :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Text &quot;&quot;&quot;</span>

    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;text x=&quot;{0}&quot; y=&quot;{1}&quot;&gt;{2}&lt;/text&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;text x=&quot;{0}&quot; y=&quot;{1}&quot; style=&quot;{2}&quot;&gt;{3}&lt;/text&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
</pre></div>
<p>Et voilà le module complet :</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SVGwriter</span><span class="p">:</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We do not remember title and desc &#39;cause we won&#39;t need them anymore after header</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span>

        <span class="c1"># output buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">([</span>
            <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; version=&quot;1.1&quot; width=&quot;{0}&quot; height=&quot;{1}&quot;&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span>
            <span class="s1">&#39;&lt;title&gt;{0}&lt;/title&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">),</span>
            <span class="s1">&#39;&lt;desc&gt;{0}&lt;/desc&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Append a line or a list of lines to the output buffer &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save self.lines to filename &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s2">&quot;&lt;/svg&gt;&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Rectangle &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;rect width=&quot;{0}&quot; height=&quot;{1}&quot; x=&quot;{2}&quot; y=&quot;{3}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;rect width=&quot;{0}&quot; height=&quot;{1}&quot; x=&quot;{2}&quot; y=&quot;{3}&quot; style=&quot;{4}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Circle &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;circle cx=&quot;{0}&quot; cy=&quot;{1}&quot; r=&quot;{2}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;circle cx=&quot;{0}&quot; cy=&quot;{1}&quot; r=&quot;{2}&quot; style=&quot;{3}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Line &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;line x1=&quot;{0}&quot; y1=&quot;{1}&quot; x2=&quot;{2}&quot; y2=&quot;{3}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;line x1=&quot;{0}&quot; y1=&quot;{1}&quot; x2=&quot;{2}&quot; y2=&quot;{3}&quot; style=&quot;{4}&quot; /&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">style</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Text &quot;&quot;&quot;</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;text x=&quot;{0}&quot; y=&quot;{1}&quot;&gt;{2}&lt;/text&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_out</span><span class="p">(</span><span class="s1">&#39;&lt;text x=&quot;{0}&quot; y=&quot;{1}&quot; style=&quot;{2}&quot;&gt;{3}&lt;/text&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Nous avons donc nos deux outils, reste à écrire le programe final. La suite au <a class="reference external" href="/writing/icaldraw-partie-2-dessine-moi-un-planning/">prochain épisode</a> !</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Pour la partie SVG, l'ouvrage <em>SVG Essentials</em> d'O'Reilly est un vrai plus (ISBN-13 : 978-0596002237 ou <a class="reference external" href="http://commons.oreilly.com/wiki/index.php/SVG_Essentials">en ligne</a>).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>En bonus, on ne s'en servira pas ici, mais comme ça le module sera un peu plus général... pour 3
lignes de code en plus :</td></tr>
</tbody>
</table>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>