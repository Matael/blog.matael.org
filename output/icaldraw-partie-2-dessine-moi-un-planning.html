<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="svg" />
		<meta name="tags" content="python" />
		<meta name="tags" content="ical" />
		<meta name="tags" content="fac" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>IcalDraw (Partie 2) : Dessine moi un planning</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:42+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/svg.html">svg</a></li>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/ical.html">ical</a></li>
				<li><a href="/tag/fac.html">fac</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>.</p>
<blockquote>
Pensez à lire la <a class="reference external" href="/writing/icaldraw-partie-1-quelques-outils/">première partie</a></blockquote>
<div class="section" id="resume-de-l-episode-precedent">
<h2>Résumé de l'épisode précédent</h2>
<p>Au cours de la première partie, nous avons écrit deux outils nous permettant respectivement de :</p>
<ul class="simple">
<li>récupérer une liste d'évènements Ical à partir d'une URL ou d'un fichier</li>
<li>dessiner des choses dans un fichier SVG</li>
</ul>
<p>Nous allons repartir de cette base et remplir les deux derniers objectifs fixés :</p>
<ul class="simple">
<li>écrire le programme lui même permettant la génération des images</li>
<li>écrire un script l'utilisant</li>
</ul>
<p>Pour ceux qui n'auraient pas suivi, on cherche à obtenir ça :</p>
<img alt="" class="align-center" src="/static/images/icaldraw/exemple.png" style="width: 800px;" />
<p>Pour commencer, essayez d'avoir une arborescence comme celle-ci</p>
<pre class="literal-block">
.
├── __init__.py
├── fetcher.py
├── icaldraw.py
└── svgutils.py
</pre>
<p><tt class="docutils literal">__init__.py</tt> contient une ligne blanche, <tt class="docutils literal">fetcher.py</tt> la classe <tt class="docutils literal">IcalFetcher</tt> et ce qui s'y rapporte,
<tt class="docutils literal">svgutils.py</tt> la classe <tt class="docutils literal">SVGwriter</tt> et enfin, nous alons travailler dans <tt class="docutils literal">icaldraw.py</tt>.</p>
</div>
<div class="section" id="decoupage-des-methodes">
<h2>Découpage des méthodes</h2>
<p>Voilà comment seront réparties les fonctionnalités de la classe <tt class="docutils literal">IcalDraw</tt> :</p>
<ul class="simple">
<li>méthodes spéciales :<ul>
<li>constructeur <tt class="docutils literal">__init__()</tt> : initialisation des variables objet, instanciation de <tt class="docutils literal">IcalFetcher</tt> et récupération
d'un itérateur sur la liste d'évènements, instanciation de <tt class="docutils literal">SVGwriter</tt>.</li>
</ul>
</li>
<li>méthodes publiques :<ul>
<li><tt class="docutils literal">draw()</tt> : lance la création de l'image</li>
<li><tt class="docutils literal">save()</tt> : raccourci pour sauver l'image</li>
</ul>
</li>
<li>méthodes privées :<ul>
<li><tt class="docutils literal">_header()</tt> : ajout de l'entête du planning (<em>&quot;Semaine du DD/MM&quot;</em>)</li>
<li><tt class="docutils literal">_grid()</tt> : dessin de la grille horaire grise en fond, ajout des numéros des jours</li>
<li><tt class="docutils literal">_place_events()</tt> : utilisation de la liste d'évènements pour les dessiner sur la grille, le gros du boulot se fera
ici</li>
</ul>
</li>
</ul>
<p>On va les écrire dans l'ordre où elles sont notées ici.</p>
</div>
<div class="section" id="icaldraw">
<h2>IcalDraw</h2>
<div class="section" id="imports-and-boilerplate">
<h3>Imports and boilerplate</h3>
<p>Voilà la base de la base :</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fetcher</span> <span class="kn">import</span> <span class="n">IcalFetcher</span>
<span class="kn">from</span> <span class="nn">svgutils</span> <span class="kn">import</span> <span class="n">SVGwriter</span>

<span class="k">class</span> <span class="nc">IcalDraw</span><span class="p">:</span>
    <span class="c1"># code....</span>
</pre></div>
</div>
<div class="section" id="constructeur">
<h3>Constructeur</h3>
<p>Le code du constructeur se comprend tout seul (comme celui des méthodes publiques, vous verrez) :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">utc_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stroke_color</span><span class="o">=</span><span class="s2">&quot;rgb(5%, 32%, 65%)&quot;</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="c1"># url dans laquelle lire les données ICAL...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="nb">file</span> <span class="c1"># ... ou fichier dans lequel lire les données ICAL</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">utc_offset</span> <span class="o">=</span> <span class="n">utc_offset</span> <span class="c1"># pour des heures correctes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">stroke_color</span> <span class="o">=</span> <span class="n">stroke_color</span> <span class="c1"># couleur générale</span>

    <span class="c1"># space to be left as a header</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span> <span class="o">=</span> <span class="mi">45</span>

    <span class="c1"># récupération des évènements</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cal</span> <span class="o">=</span> <span class="n">IcalFetcher</span><span class="p">()</span>
    <span class="c1"># si une url ET un fichier sont fournis, l&#39;URL prime.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Give me a source !&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">get_events</span><span class="p">()</span>

    <span class="c1"># initialisation de l&#39;image</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">=</span> <span class="n">SVGwriter</span><span class="p">(</span><span class="mi">1360</span><span class="p">,</span> <span class="mi">430</span><span class="p">)</span>
</pre></div>
<p>Pour ce qui est de la dernière ligne et ses valeurs précalculées (<a class="reference external" href="http://www.youtube.com/watch?v=Gsz4EkGQSHw">An Human did this...</a>), voilà l'explication.</p>
<p>On va afficher 7 jours, et un intervale horaire allant de 8h à 19h (soit 11h).</p>
<p>Pour la largeur (1360 ici) : je compte 120 par heure à quoi j'ajoute 20 de marge de chaque côté
soit :</p>
<div class="formula">
<i>w</i> = 120*11 + 2*20 = 1320 + 40 = 1360
</div>
<p>Pour la hauteur maintenant, je commence avec le <tt class="docutils literal">blank_header</tt> puis 30 de marge et enfin 50 par jour :</p>
<div class="formula">
<i>h</i> = 45 + 30 + 50*7 = 430
</div>
<p>Une meilleure solution serait de parcourir une première fois la liste pour savoir sur combien de jours se répartissent
les évènements et d'utiliser ce nombre. On pourrait aussi rechercher à quelle heure commence l'évènement ayant lieu le
plus tôt et à quelle heure se termine celui qui se finit le plus tard pour savoir combien d'heures afficher.</p>
<p>Pour une autre version peut être....</p>
</div>
<div class="section" id="methode-publique-draw">
<h3>Methode publique : draw()</h3>
<p>Celle-ci se contente d'appeler les méthodes privées :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_place_events</span><span class="p">()</span>
</pre></div>
<p>L'ordre d'appel a une importance : les derniers éléments ajoutés apparaissent au dessus des premiers sur l'image.</p>
</div>
<div class="section" id="methode-publique-save">
<h3>Méthode publique : save()</h3>
<p>Je n'explique pas là.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="methode-privee-header">
<h3>Méthode privée : _header()</h3>
<p>On ajoute un texte dans le <tt class="docutils literal">blank_header</tt> (centré au mileu du <tt class="docutils literal">blank_header</tt> horizontalement et aux deux tiers
verticalement). Comme texte on met &quot;Semaine du DD/MM&quot; avec DD le jour du premier évènement et MM son mois.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
        <span class="s2">&quot;Semaine du {0}/{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">month</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="s2">&quot;text-anchor: middle; font-size: 30; alignment-baseline: middle; letter-spacing: 2pt; stroke: {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stroke_color</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="section" id="methode-privee-grid">
<h3>Méthode privée : _grid()</h3>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Draw a hours&amp;days grid &quot;&quot;&quot;</span>

    <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;stroke: black; stroke-opacity: 0.4;&quot;</span>

    <span class="c1"># vertical</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span> <span class="c1"># [0 .. 11]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">18</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
                <span class="mi">20</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="mi">120</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span>
                <span class="mi">20</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="mi">120</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="o">+</span><span class="s2">&quot;stroke-width: 3;&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
                <span class="mi">20</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="mi">120</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span>
                <span class="mi">20</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="mi">120</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">style</span>
            <span class="p">)</span>

    <span class="c1"># horizontal</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span> <span class="c1"># [0 .. 6]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
            <span class="mi">10</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;n+{}&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
            <span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="n">n</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="s2">&quot;text-anchor: middle; letter-spacing: 2pt;&quot;</span><span class="o">+</span><span class="n">style</span>
        <span class="p">)</span>
</pre></div>
<p>Notez l'utilisation de <tt class="docutils literal"><span class="pre">stroke-opacity</span></tt> pour atténuer le noir des lignes et le fait que les marges soient plus faibles
que celle décrites au dessus. Ce second point permet de faire en sorte que les lignes guides dépassent un peu.</p>
<p>Enfin, plutot que m'embèter à remettre les dates pour chaque ligne, j'ai choisi d'ajouter un indice de <em>n</em> à <em>n+6</em> <a class="footnote-reference" href="#id3" id="id1">[1]</a> à
droite au bout des lignes pour chaque jour (deuxième partie de la deuxième boucle).</p>
</div>
<div class="section" id="methode-privee-place-events">
<h3>Méthode privée : _place_events()</h3>
<p>Là, ça se corse, d'abord la méthode est plus longue et de deux, c'est elle qui fait tout le boulot.
Le début est fortement inspiré de l'article proposant un passage de l'Ical au PDF, la suite n'est que dessin :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_place_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Places events on timelines &quot;&quot;&quot;</span>

    <span class="c1"># on retient le jour précédent pour savoir s&#39;il</span>
    <span class="c1"># faut changer de ligne</span>
    <span class="n">previous_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">day</span>
    <span class="c1"># nb_days nous dit sur quelle ligne se placer</span>
    <span class="n">nb_days</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># on itère sur les évènements</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal</span><span class="p">:</span>

        <span class="c1"># test pour changement de ligne</span>
        <span class="k">if</span> <span class="n">previous_d</span> <span class="o">!=</span> <span class="n">e</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>

            <span class="c1"># on calcule combien de jours séparent l&#39;évènement</span>
            <span class="c1"># précédent de celui en cours (pour les problèmes de</span>
            <span class="c1"># ligne à laisser vide, toussa....)</span>
            <span class="n">nb_days</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">day</span> <span class="o">-</span> <span class="n">previous_d</span>
            <span class="n">previous_d</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">day</span>

        <span class="c1"># on a dit qu&#39;on affichait que pour 7 jours (de toute façon, on a que 7 lignes)</span>
        <span class="k">if</span> <span class="n">nb_days</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>

            <span class="c1"># on calcule les abscisses de début et de fin</span>
            <span class="c1"># start_px = padding +</span>
            <span class="c1">#   (heure début + correction utc - début de l&#39;échelle de temps)* longueur choisie +</span>
            <span class="c1">#   (nombre de &quot;5minutes&quot; après l&#39;heure de début) * longueur choisie pour 5minutes</span>
            <span class="c1"># idem pour la fin</span>
            <span class="c1"># le milieu (middle_px) correspond au début + la moitié de la durée de l&#39;évènement</span>
            <span class="c1">#   on l&#39;utilise pour centrer le texte</span>
            <span class="c1"># la hauteur correspond au blank_header + la marge + nb_days*50 et elle permet</span>
            <span class="c1">#   de se positionner sur une ligne</span>
            <span class="n">start_px</span> <span class="o">=</span> <span class="mi">20</span><span class="o">+</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">hour</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">utc_offset</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">120</span><span class="o">+</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">dtstart</span><span class="o">.</span><span class="n">minute</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
            <span class="n">end_px</span> <span class="o">=</span> <span class="mi">20</span><span class="o">+</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">dtend</span><span class="o">.</span><span class="n">hour</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">utc_offset</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">120</span><span class="o">+</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">dtend</span><span class="o">.</span><span class="n">minute</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span>
            <span class="n">middle_px</span> <span class="o">=</span> <span class="n">start_px</span> <span class="o">+</span> <span class="p">(</span><span class="n">end_px</span><span class="o">-</span><span class="n">start_px</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blank_header</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">50</span><span class="o">*</span><span class="n">nb_days</span>

            <span class="c1"># on ajoute la ligne entre start_px et end_px</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
                <span class="n">start_px</span><span class="p">,</span>
                <span class="n">height</span><span class="p">,</span>
                <span class="n">end_px</span><span class="p">,</span>
                <span class="n">height</span><span class="p">,</span>
                <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;stroke: {}; stroke-width: 10;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stroke_color</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># on ajoute par-dessus les cercles de début et de fin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_circle</span><span class="p">(</span>
                <span class="n">start_px</span><span class="p">,</span>
                <span class="n">height</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;fill: {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stroke_color</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_circle</span><span class="p">(</span>
                <span class="n">end_px</span><span class="p">,</span>
                <span class="n">height</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;fill: {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stroke_color</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># au dessus de la ligne, on met l&#39;intitulé du cours</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
                <span class="n">e</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span>
                <span class="n">middle_px</span><span class="p">,</span>
                <span class="n">height</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;text-anchor: middle; font-size: 0.8em; letter-spacing: 2pt; stroke: {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stroke_color</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># et en dessous la salle</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span>
                <span class="n">e</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                <span class="n">middle_px</span><span class="p">,</span>
                <span class="n">height</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;text-anchor: middle; font-size: 0.8em; letter-spacing: 2pt; stroke: {};&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stroke_color</span><span class="p">)</span>
            <span class="p">)</span>
</pre></div>
<p>Et voilà !</p>
<p>En dehors du bidouillage de coordonnées, ça va :) D'ailleurs, en voyant le découpage par 5 minutes, vous comprennez
pourquoi j'ai pris 120 et non 100 pour 1 heure : 120 ça se divise facilement par 12 :).</p>
<p>Voilà donc pour ce module qui était fatiguant par ses problèmes de coordonnées (j'ai horreur de ça).</p>
<p>Reste maintenant à écrire le script qui l'utilise :</p>
</div>
</div>
<div class="section" id="script-final">
<h2>Script final</h2>
<p>Là, rien de plus simple, on va refaire le planning de l'exemple (donc à partir d'un fichier Ical).</p>
<p>Le fichier est <a class="reference external" href="/static/images/icaldraw/exemple.ics">téléchargeable ici</a></p>
<p>Et pour le code, rien de plus simple :</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">icaldraw</span> <span class="kn">import</span> <span class="n">IcalDraw</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">FILE</span> <span class="o">=</span> <span class="s2">&quot;exemple.ics&quot;</span>


    <span class="nb">id</span> <span class="o">=</span> <span class="n">IcalDraw</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">FILE</span><span class="p">)</span>
    <span class="nb">id</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="nb">id</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;exemple.svg&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
<p>Et voilà !</p>
</div>
<div class="section" id="le-tout-avec-style">
<h2>Le tout avec style !</h2>
<p>Vous aurez noté que je n'ai pas parlé une seule fois des arguments <tt class="docutils literal">style</tt> qui sont pourtant partout.</p>
<p>Je n'ai pas envie de détailler l'ensemble des propriétés de style du SVG mais sachez qu'elles sont nombreuse.
Pour tout ce qui touche aux spécification de ce format assez puissant (oui, oui, on peut même faire des jeux en JS+SVG,
c'est dire.), je vous renvoie à <em>SVG Essentials</em> d'O'Reilly  <a class="footnote-reference" href="#id4" id="id2">[2]</a>.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Bon, soyons francs, je suis plutot satisfait du résultat. Toutefois, comme je l'ai déjà dit dans d'autres articles,
cette API d'export n'est pas faite pour être utilisée en dehors d'un agenda, et ça se sent (dans les lieux associés par
exemple, il y a plein de données inutiles). On arrive toujours au même point : une API plus générale ne serait pas un
mal (ou une meilleure conformité avec l'Ical, qui ne recommande pas d'écrire un roman dans le champ LOCATION)</p>
<p>Finalement, je suis surtout content d'une chose : le module pour le SVG est assez efficace et suffisant pour une majorité des
utilisation que j'en ferais.</p>
<p>D'ailleurs, il n'est pas impossible qu'il deviennent un module à part entière...</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Quoi ? Moi, faire des maths ? Non. C'est faux.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>ISBN-13 : 978-0596002237 ou <a class="reference external" href="http://commons.oreilly.com/wiki/index.php/SVG_Essentials">en ligne</a></td></tr>
</tbody>
</table>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>