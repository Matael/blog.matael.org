<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="ical" />
		<meta name="tags" content="fac" />
		<meta name="tags" content="python" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>ICal Generator for Academics</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2016-08-16T00:19:39+02:00">Tue 16 August 2016</span></p>
		<ul class=tags>
				<li><a href="/tag/ical.html">ical</a></li>
				<li><a href="/tag/fac.html">fac</a></li>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Conferences are an important part of scientific life and, even if I'm pretty new to this
world, I understand planning one's tour at a conference can be a real hassle.</p>
<p>The context that led to the following project is pretty common for most scientists. My
friend <a class="reference external" href="http://fredblain.org/">Fred Blain</a> from <a class="reference external" href="http://www.sheffield.ac.uk/">USFD</a> was preparing for the <a class="reference external" href="http://acl2016.org/">ACL2016</a> conference in Berlin.
This year's ACL was a huge (1.6k researchers) conference with a lot of talks in up to 7
tracks in parallel. The program was announced <a class="reference external" href="http://acl2016.org/index.php?article_id=12">on the website</a> but, as usual, not easy to
mine and dissect.</p>
<p>On a proposal from Fred, we decided to tackle the challenge of making this program easier
to prune down to a small, personal interest list.</p>
<blockquote>
The rest of the article describes the parsing and restitution processes. The result can
be found <a class="reference external" href="https://acl2016.fredblain.org/">here</a>.</blockquote>
<div class="section" id="parsing-the-html-page">
<h2>Parsing the HTML page</h2>
<p>We'll go through the parsing process and the creation of a webapp to browse the program
and generate an ICAL.</p>
<p>On the ACL website, some pages provide a detailed program (such as <a class="reference external" href="http://acl2016.org/index.php?article_id=64">http://acl2016.org/index.php?article_id=64</a> ), we'll use that to generate a JSON list of events for each day.</p>
<div class="section" id="setting-up-the-basics">
<h3>Setting up the basics</h3>
<p>Let's first implement a base in which we could implement the parsing process:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">get</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="k">class</span> <span class="nc">ConferenceDay</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">day_id</span> <span class="o">=</span> <span class="n">day_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;http://acl2016.org/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="o">+</span><span class="s1">&#39;index.php?article_id=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">day_id</span><span class="p">))</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_rooms_mapper</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s2">&quot;Audimax&quot;</span><span class="p">,</span>
            <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="s2">&quot;Kinosaal&quot;</span><span class="p">,</span>
            <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s2">&quot;2002&quot;</span><span class="p">,</span>
            <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="s2">&quot;3038&quot;</span><span class="p">,</span>
            <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s2">&quot;2094&quot;</span><span class="p">,</span>
            <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="s2">&quot;2091&quot;</span><span class="p">,</span>
            <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s2">&quot;2097&quot;</span>
        <span class="p">}</span>
</pre></div>
<p>The class will hold everything, the room mapper is linked to the distribution of rooms at
the venue.</p>
</div>
<div class="section" id="page-structure">
<h3>Page structure</h3>
<p>First thing to do, as usual, is to study the page structure. One can easily show that the
full page is actually a long table. Let's walk through the table's rows and understand the
different features:</p>
<ul class="simple">
<li>The global events are in bold (tagged with <tt class="docutils literal">&lt;strong&gt;</tt>)</li>
<li>The sessions are preceeded by a <tt class="docutils literal">&lt;h3&gt;</tt> title with the session's name</li>
<li>Some useless events are present (Lunch &amp; Coffee breaks)</li>
<li>Some rows are here for padding only</li>
</ul>
<p>Let's write a loop over the table's rows to classify them. As an output, we want a list of
lists containing the row's content (as BeautifulSoup object) if it's a paper, the session
name as a string if it's a title or a tuple <tt class="docutils literal">(time,name)</tt> if it's one of the global
activities.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parse_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># list of events not to log</span>
    <span class="n">KILL_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Coffee break&#39;</span><span class="p">,</span> <span class="s1">&#39;Lunch break&#39;</span><span class="p">]</span>

    <span class="c1"># empty list of events and boolean to know if we&#39;re</span>
    <span class="c1"># in one of the sets of activities (Lunch, Coffee, etc...)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">list_events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_activity_list</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">row</span><span class="p">:</span>
        <span class="c1"># if it&#39;s a title, add a new sublist</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_events</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()])</span>
            <span class="n">in_activity_list</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># beginning of session =&gt; end of global activity time</span>

        <span class="c1"># if the second column is of length 1 =&gt; activity or empty row</span>
        <span class="c1"># in beautiful soup the contents&#39; length of a tag with 1 children only</span>
        <span class="c1"># is of length 1</span>
        <span class="c1"># the &quot;empty&quot; rows are 1 character rows =&gt; len()=1</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># if strong =&gt; activity</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;strong&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;strong&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="ow">in</span> <span class="n">KILL_LIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">in_activity_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_events</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">in_activity_list</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">(),</span>
                      <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;strong&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">())</span>
                <span class="p">)</span>

            <span class="c1"># empty row, discard</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># it&#39;s a normal row =&gt; add it to the current list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="c1"># neeext !</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find_next_sibling</span><span class="p">()</span>
</pre></div>
<p>Of course, the <tt class="docutils literal">else: pass</tt> is optional but is kept because <a class="reference external" href="https://www.python.org/dev/peps/pep-0020/">readability counts</a>.
The function is straight forward, it just checks line by line for a title, a global
activity or a normal paper and create sublist for sets of activities or sessions.</p>
</div>
<div class="section" id="from-list-to-dict">
<h3>From list to dict</h3>
<p>Now we have the list, let's transform it into a dict mapping each timeframe with
corresponding events.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_events</span><span class="p">:</span>
        <span class="c1"># very long lists are posters or demo</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">15</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># check if the sublist is full string =&gt; global events</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">==</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">sub</span><span class="p">)))</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;global_session&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># normal session</span>
            <span class="c1"># the first item was always the session name</span>
            <span class="n">session_title</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># retrieve session room (last character of the session number)</span>
            <span class="n">session_room</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_rooms_mapper</span><span class="p">[</span><span class="n">session_title</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">talk</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">local_timeframe</span> <span class="o">=</span> <span class="n">talk</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
                <span class="n">paper_title</span> <span class="o">=</span> <span class="n">talk</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
                <span class="n">paper_authors</span> <span class="o">=</span> <span class="n">talk</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">local_timeframe</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">local_timeframe</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">local_timeframe</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;session_name&#39;</span><span class="p">:</span> <span class="n">session_title</span><span class="p">,</span>
                      <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">paper_title</span><span class="p">,</span>
                      <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="n">paper_authors</span><span class="p">,</span>
                      <span class="s1">&#39;room&#39;</span><span class="p">:</span> <span class="n">session_room</span><span class="p">}</span>
                <span class="p">)</span>
</pre></div>
<p>This second function goes through the previously created list and build the dict:</p>
<ul class="simple">
<li>It first kicks out every sublist with more thant 15 entries (that corresponds to poster sessions or demo in the present conference).</li>
<li>It creates a global event entry for each sublist composed only of tuple</li>
<li>It generate a JSON entry with the right session name and room for other papers</li>
</ul>
<p>Finally, don't forget to call those last two functions in <tt class="docutils literal">__init__</tt> if you want the
list to be created at instantiation:</p>
<div class="highlight"><pre><span></span><span class="n">parse_html</span><span class="p">()</span>
<span class="n">generate_dict</span><span class="p">()</span>
</pre></div>
<p>In the end, the attribute <tt class="docutils literal">events</tt> holds the full list of events, timeframe by
timeframe.</p>
</div>
</div>
<div class="section" id="bundling-into-a-website">
<h2>Bundling into a website</h2>
<p>In order to make all this accessible and easily profitable, let's build a small webapp
around it.</p>
<div class="section" id="design-considerations">
<h3>Design considerations</h3>
<p>The number of expected researchers was high for a conference but not for a webapp, we
decided a simple plain JSON file could serve as a simple database. Note that this is <strong>not
true</strong> in general and is highly correlated with my laziness.</p>
<p>We are bad at creating beautiful designs but <a class="reference external" href="https://html5up.net">HTML5 Up</a> is not, we downloaded the
style-sheet and HTML boilerplate from them (it's called <a class="reference external" href="https://html5up.net/prologue">Prologue</a>). As the theming part
is just a matter of integration it will not be discussed here.</p>
</div>
<div class="section" id="generating-the-database">
<h3>Generating the database</h3>
<p>As we didn't want to kill ACL website by generating 3 requests to their servers every time
1 is sent to ours, let's cache the cleaned list of events and talks.</p>
<p>This is done simply using the following script (the comments should make it sufficiently
readable):</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ACLConf</span> <span class="kn">import</span> <span class="n">ConferenceDay</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dump</span>

<span class="c1"># filename where to store the final lists</span>
<span class="n">DB_NAME</span> <span class="o">=</span> <span class="s2">&quot;./days.json&quot;</span>

<span class="c1"># each day is associated to the corresponding article_id from ACL Website</span>
<span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;monday&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
    <span class="s1">&#39;tuesday&#39;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span>
    <span class="s1">&#39;wednesday&#39;</span><span class="p">:</span> <span class="mi">66</span>
<span class="p">}</span>

<span class="c1"># create and fill a dict with day_name -&gt;  event list by timeframe</span>
<span class="n">days</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">day_name</span><span class="p">,</span><span class="n">day_id</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">days</span><span class="p">[</span><span class="n">day_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ConferenceDay</span><span class="p">(</span><span class="n">day_id</span><span class="p">)</span><span class="o">.</span><span class="n">events</span>

<span class="c1"># write it all in the &quot;DB&quot; file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DB_NAME</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
    <span class="n">dump</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="the-webapp">
<h3>The webapp</h3>
<p>As often in my projects, the webapp is built on top of <a class="reference external" href="http://bottlepy.org">Bottle</a>. It consist in 2 functions:</p>
<ul class="simple">
<li>the first view, responding on <tt class="docutils literal">/</tt> shows 1 form per day and allows one to pick up
interesting talks and click on a <em>Generate ICAL</em> button to get the file (1 per day);</li>
<li>the second one process the POST data from the form and generate the ICAL itself</li>
</ul>
<p>Let's start with the usual boilerplate (imports and static file URL):</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span>\
    <span class="n">route</span><span class="p">,</span>\
                      <span class="n">run</span><span class="p">,</span>\
                      <span class="n">jinja2_template</span> <span class="k">as</span> <span class="n">template</span><span class="p">,</span>\
                      <span class="n">request</span><span class="p">,</span>\
                      <span class="n">response</span><span class="p">,</span>\
                      <span class="n">static_file</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/assets/&lt;filename:path&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">static</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Serves static files&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;assets/&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span> <span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>The second view to add is the index page which displays the forms. It's also the one that
reads the JSON file:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">load</span>

<span class="n">DB_NAME</span> <span class="o">=</span> <span class="s2">&quot;./days.json&quot;</span>

<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="c1"># keep a list of days so we can iterate in the right order</span>
    <span class="n">days_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;monday&#39;</span><span class="p">,</span> <span class="s1">&#39;tuesday&#39;</span><span class="p">,</span> <span class="s1">&#39;wednesday&#39;</span><span class="p">]</span>

    <span class="c1"># read from the database</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DB_NAME</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">days_contents</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="c1"># orders the sessions by ascending starting time</span>
    <span class="n">sessions_orders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">days_list</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">days_contents</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># pad the missing leading zeros</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;0&#39;</span><span class="o">+</span><span class="n">time</span><span class="p">,</span><span class="n">time</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">time</span><span class="p">,</span><span class="n">time</span><span class="p">))</span>

        <span class="c1"># Good ol&#39; sort (WARNING .sort() operates *in place*)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">sessions_orders</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>

    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
                    <span class="n">days_contents</span><span class="o">=</span><span class="n">days_contents</span><span class="p">,</span>
                    <span class="n">sessions_orders</span><span class="o">=</span><span class="n">sessions_orders</span><span class="p">,</span>
                    <span class="n">days_list</span><span class="o">=</span><span class="n">days_list</span>
    <span class="p">)</span>
</pre></div>
<p>Some may notice a better way to sort session would be to use the built-in <tt class="docutils literal">datetime</tt>
module but here's the thing: we finished this webapp at 2.30 a.m. and we didn't want to mess
around with this date-related crap.</p>
<p>The relevant part of the <tt class="docutils literal">index.html</tt> template looks like this:</p>
<div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">d</span> <span class="k">in</span> <span class="nv">days_list</span> <span class="cp">%}</span>
<span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span><span class="nv">d</span><span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span><span class="cp">{{</span><span class="nv">d</span><span class="o">|</span><span class="nf">capitalize</span><span class="cp">}}</span> sessions<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">sorted_key</span><span class="o">,</span><span class="nv">timeframe</span> <span class="k">in</span> <span class="nv">sessions_orders</span><span class="o">[</span><span class="nv">d</span><span class="o">]</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/export.ics&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;day&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span><span class="nv">d</span><span class="cp">}}</span><span class="s">&quot;</span><span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span><span class="cp">{{</span><span class="nv">timeframe</span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="cp">{%</span> <span class="k">for</span> <span class="nv">paper</span> <span class="k">in</span> <span class="nv">days_contents</span><span class="o">[</span><span class="nv">d</span><span class="o">][</span><span class="nv">timeframe</span><span class="o">]</span> <span class="cp">%}</span>
          <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">radio</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span><span class="nv">timeframe</span><span class="cp">}}</span><span class="s">&quot;</span>
                   <span class="na">id</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span><span class="nv">paper.title</span><span class="cp">}}</span><span class="s">&quot;</span>
                   <span class="na">value</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span><span class="nv">paper.title</span><span class="cp">}}</span><span class="s"></span>
<span class="s">                          </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">paper.type</span><span class="o">==</span><span class="s1">&#39;session&#39;</span> <span class="cp">%}</span><span class="s"></span>
<span class="s">                            by </span><span class="cp">{{</span><span class="nv">paper.authors</span><span class="cp">}}</span><span class="s">#</span><span class="cp">{{</span><span class="nv">paper.room</span><span class="cp">}}</span><span class="s"></span>
<span class="s">                          </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="s"></span>
<span class="s">                         &quot;</span>
            <span class="p">/&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span><span class="nv">paper.title</span><span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="cp">{{</span><span class="nv">paper.title</span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
              <span class="cp">{%</span> <span class="k">if</span> <span class="nv">paper.type</span><span class="o">==</span><span class="s1">&#39;session&#39;</span> <span class="cp">%}</span>
                <span class="p">&lt;</span><span class="nt">em</span><span class="p">&gt;</span> by <span class="cp">{{</span><span class="nv">paper.authors</span><span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;</span>
              <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
            <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
        <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
      <span class="p">&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Generate iCal!&quot;</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>
<p>It's literally just a couple of for-loops that spans one form per day and that add a new
set of radio buttons for each timeframe.</p>
</div>
<div class="section" id="generating-the-ical">
<h3>Generating the ICal</h3>
<p>Because it was 2.30 a.m. and the first time for us with the <tt class="docutils literal">icalendar</tt> package, we went
for the easy way: reuse an example <a class="reference external" href="http://icalendar.readthedocs.io/en/latest/usage.html#example">from the documentation</a>.</p>
<p>In the following view, we get the <tt class="docutils literal">POST</tt> data from the form and we process it. As all
the required data was already included in the form itself (title, authors, rooms and timeframe)
there's no need to call the DB again.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">icalendar</span> <span class="kn">import</span> <span class="n">Calendar</span><span class="p">,</span> <span class="n">Event</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># use the right extension in the route to help the</span>
<span class="c1"># OS to detect it as a calendar file</span>
<span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/export.ics&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;POST&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">generate_ical</span><span class="p">():</span>

    <span class="c1"># init the Calendar object as proposed in the example</span>
    <span class="n">cal</span> <span class="o">=</span> <span class="n">Calendar</span><span class="p">()</span>
    <span class="n">cal</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;prodid&#39;</span><span class="p">,</span> <span class="s1">&#39;-//My calendar product//mxm.dk//&#39;</span><span class="p">)</span>
    <span class="n">cal</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0&#39;</span><span class="p">)</span>

    <span class="c1"># pre-init datetime objects for date handling</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;monday&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Paris&#39;</span><span class="p">)),</span>
        <span class="s1">&#39;tuesday&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Paris&#39;</span><span class="p">)),</span>
        <span class="s1">&#39;wednesday&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Paris&#39;</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># if the field is named day it&#39;s the first (hidden) one</span>
        <span class="c1"># it will be used afterwards but does not require a special action</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="s1">&#39;day&#39;</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># update the pre-built datetime objects</span>
            <span class="n">start</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">dtstart</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                                                          <span class="n">minute</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">dtend</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                                                        <span class="n">minute</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="c1"># bundle everything into an event object</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1"># papers &quot;value&quot; in the form contain a # between authors and room</span>
                <span class="n">v_sum</span><span class="p">,</span> <span class="n">v_room</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="n">v_sum</span><span class="p">)</span>
                <span class="n">event</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="n">v_room</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

            <span class="n">event</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;dtstart&#39;</span><span class="p">,</span><span class="n">dtstart</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;dtend&#39;</span><span class="p">,</span><span class="n">dtend</span><span class="p">)</span>

        <span class="c1"># add it to the calendar and go to the next one</span>
        <span class="n">cal</span><span class="o">.</span><span class="n">add_component</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1"># change the content-type so a download is proposed</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;text/calendar&#39;</span>
    <span class="c1"># raw response without rendering</span>
    <span class="k">return</span> <span class="n">cal</span><span class="o">.</span><span class="n">to_ical</span><span class="p">()</span>
</pre></div>
<p>Aaaaannnnd... There we are!</p>
<p>A fully functionning ICal generator in less than 200 lines of code, accessible through a
web browser.</p>
</div>
</div>
<div class="section" id="what-s-next">
<h2>What's next?</h2>
<p>As usual, the result we got is not an end, there's plenty of other conferences to come and
it could be awesome to provide such a tool for every single one. This will require a
better codebase, with a more modular architecture and a more efficient engine.</p>
<p>For those who think it's kind of overkill to use such a solution, some commercial
alternatives exist and particularly <a class="reference external" href="http://conference4me.psnc.pl/">Conference4Me</a>. The tool proposed here doesn't serve the same purpose though: no application, no &quot;branded&quot; content nor support; just an idea, a need and a bunch of lines to fill it.</p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>