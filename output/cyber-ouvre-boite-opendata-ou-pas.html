<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="setram" />
		<meta name="tags" content="LeMans" />
		<meta name="tags" content="python" />
		<meta name="tags" content="haum" />
		<meta name="tags" content="opendata" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Cyber-Ouvre-Boite : Opendata... ou pas.</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:42+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/setram.html">setram</a></li>
				<li><a href="/tag/lemans.html">LeMans</a></li>
				<li><a href="/tag/python.html">python</a></li>
				<li><a href="/tag/haum.html">haum</a></li>
				<li><a href="/tag/opendata.html">opendata</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>Voilà plusieurs mois, au cours d'un Jeudi du Libre (rencontres organisées à l'Epicerie du Pré par LinuxMaine autour du
LL et de l'écosystème qui l'entoure), nous avions discuté de la déplorable absence d'API pour les horaires de la SETRAM.</p>
<p>En bons bidouilleurs assoiffés de hack et dans un élan de datalove, nous nous étions souvenus de la présence d'un
service (appelé Timéo) permettant d'obtenir les heures des prochains passages de bus/tram à partir d'un code noté dans
l'arrêt. La bière avait ensuite coulé et la diiscussion en était restée là.</p>
<p>Aujourd'hui, par un superbe matin de pluie, je me suis dit qu'il était temps de creuser un peu le sujet.</p>
<p>Premier rendez vous sur <a class="reference external" href="http://setram.fr">setram.fr</a>. En bas, à peu près au milieu, l'objet du hack : un widget Timéo (widget qui semble
un peu buggé d'ailleurs... mais passons).
Je teste le bazar avec un code au pif et je me retrouve sur <a class="reference external" href="http://setram.fr/698-TIMEO2C-l-info-en-temps-reel.html">cette page</a> et, regardant un peu le code source je vois ça
:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">IFRAME</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://dev.actigraph.fr/actipages/setram/pivk/acti.php?a=recherche_arret&amp;arret=Université&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">680</span> <span class="na">height</span><span class="o">=</span><span class="s">500</span> <span class="na">scrolling</span><span class="o">=</span><span class="s">auto</span> <span class="na">frameborder</span><span class="o">=</span><span class="s">0</span> <span class="na">allowtransparency</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">IFRAME</span><span class="p">&gt;</span>
</pre></div>
<p>Certes, l'utilisation d'iframe pourrait être motif de pendaison, mais ce n'est pas l'objet aujourd'hui. Par contre l'URL
est intéressante. Si on essaye de l'ouvrir dans un navigateur (sans les arguments <tt class="docutils literal">GET</tt>), on est redirigé vers cette
<a class="reference external" href="http://dev.actigraph.fr/actipages/setram/pivk/relais.html.php">URL ci</a>.</p>
<p>Beaucoup plus intéressant déjà... en plus, le code source est nettement plus bavard et on peut y voir ceci :</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;form_ligne&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;relais.html.php&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;a&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;recherche_ligne&#39;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;input&#39;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#39;width:100%;&#39;</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">em</span><span class="p">&gt;&lt;</span><span class="nt">select</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;ligne_sens&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;ligne_sens&#39;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">&gt;</span>S<span class="ni">&amp;eacute;</span>lectionnez une ligne<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;2_A&#39;</span><span class="p">&gt;</span>Ligne 2 &gt; GALLIERE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;2_R&#39;</span><span class="p">&gt;</span>Ligne 2 &gt; BEAUREGARD<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;3_A&#39;</span><span class="p">&gt;</span>Ligne 3 &gt; OASIS<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;3_R&#39;</span><span class="p">&gt;</span>Ligne 3 &gt; GAZONFIER<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;4_A&#39;</span><span class="p">&gt;</span>Ligne 4 &gt; LA PAIX<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;4_R&#39;</span><span class="p">&gt;</span>Ligne 4 &gt; SAINT GEORGES - ST JOSEPH<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;5_A&#39;</span><span class="p">&gt;</span>Ligne 5 &gt; ARNAGE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;5_R&#39;</span><span class="p">&gt;</span>Ligne 5 &gt; GARE ROUTIERE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;6_A&#39;</span><span class="p">&gt;</span>Ligne 6 &gt; SAINT MARTIN<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;6_R&#39;</span><span class="p">&gt;</span>Ligne 6 &gt; LAFAYETTE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;7_A&#39;</span><span class="p">&gt;</span>Ligne 7 &gt; RAINERIES<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;7_R&#39;</span><span class="p">&gt;</span>Ligne 7 &gt; SAINT MARTIN<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;8_A&#39;</span><span class="p">&gt;</span>Ligne 8 &gt; LES HALLES<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;8_R&#39;</span><span class="p">&gt;</span>Ligne 8 &gt; PARC MANCEAU<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;9_A&#39;</span><span class="p">&gt;</span>Ligne 9 &gt; ZAMENHOF<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;9_R&#39;</span><span class="p">&gt;</span>Ligne 9 &gt; COMTES DU MAINE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;11_A&#39;</span><span class="p">&gt;</span>Ligne 11 &gt; CLOSERIE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;11_R&#39;</span><span class="p">&gt;</span>Ligne 11 &gt; LE CADRAN - SAINT AUBIN<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;12_A&#39;</span><span class="p">&gt;</span>Ligne 12 &gt; SAINT MARTIN<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;12_R&#39;</span><span class="p">&gt;</span>Ligne 12 &gt; REPUBLIQUE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;16_A&#39;</span><span class="p">&gt;</span>Ligne 16 &gt; ALLONNES<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;16_R&#39;</span><span class="p">&gt;</span>Ligne 16 &gt; GARES<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;17_A&#39;</span><span class="p">&gt;</span>Ligne 17 &gt; OASIS<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;17_R&#39;</span><span class="p">&gt;</span>Ligne 17 &gt; CIMETIERE DE L&#39;OUEST<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;18_A&#39;</span><span class="p">&gt;</span>Ligne 18 &gt; ROUILLON<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;18_R&#39;</span><span class="p">&gt;</span>Ligne 18 &gt; SAINT-AUBIN<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;19_A&#39;</span><span class="p">&gt;</span>Ligne 19 &gt; GUETTELOUP<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;19_R&#39;</span><span class="p">&gt;</span>Ligne 19 &gt; LA PAIX<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;20_A&#39;</span><span class="p">&gt;</span>Ligne 20 &gt; EPERON<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;20_R&#39;</span><span class="p">&gt;</span>Ligne 20 &gt; AIGN<span class="ni">&amp;Eacute;</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;21_A&#39;</span><span class="p">&gt;</span>Ligne 21 &gt; ARNAGE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;21_R&#39;</span><span class="p">&gt;</span>Ligne 21 &gt; SAINT MARTIN<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;22_A&#39;</span><span class="p">&gt;</span>Ligne 22 &gt; COMTES DU MAINE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;22_R&#39;</span><span class="p">&gt;</span>Ligne 22 &gt; SARGE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;23_A&#39;</span><span class="p">&gt;</span>Ligne 23 &gt; YVRE L&#39;EVEQUE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;23_R&#39;</span><span class="p">&gt;</span>Ligne 23 &gt; REPUBLIQUE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;24_A&#39;</span><span class="p">&gt;</span>Ligne 24 &gt; MULSANNE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;24_R&#39;</span><span class="p">&gt;</span>Ligne 24 &gt; RUAUDIN<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;25_A&#39;</span><span class="p">&gt;</span>Ligne 25 &gt; CHAMPAGN<span class="ni">&amp;Eacute;</span><span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;25_R&#39;</span><span class="p">&gt;</span>Ligne 25 &gt; R<span class="ni">&amp;Eacute;</span>PUBLIQUE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;26_A&#39;</span><span class="p">&gt;</span>Ligne 26 &gt; ALLONNES<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;26_R&#39;</span><span class="p">&gt;</span>Ligne 26 &gt; SAINT GEORGES - SAINT JOSEPH<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;33_A&#39;</span><span class="p">&gt;</span>Ligne 33 &gt; COMTES DU MAINE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;33_R&#39;</span><span class="p">&gt;</span>Ligne 33 &gt; BELLEVUE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;T1_A&#39;</span><span class="p">&gt;</span>Ligne T1 &gt; UNIVERSITE<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;T1_R&#39;</span><span class="p">&gt;</span>Ligne T1 &gt; ESPAL - ANTARES MMArena<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
<p>Ce formulaire appelle donc la même page que celle qui l'a affiché. Les options contiennent les lignes assorties de leur
sens (dans les <em>values</em> il est noté <tt class="docutils literal">A</tt> ou <tt class="docutils literal">R</tt> pour le sens).</p>
<p>Cool....</p>
<p>Voyons ce qui se passe si on entre une valeur et qu'on  regarde la requête (c'est du <tt class="docutils literal">POST</tt>, il faudra regarder les
headers). Voilà les valeurs du formulaire posté si on sélectionnne la dernière ligne de la liste</p>
<pre class="literal-block">
a: recherche_ligne
ligne_sens: T1_R
</pre>
<p>Pas trop compliqué... On arrive alors sur une autre page qui contient un autre champ <tt class="docutils literal">select</tt> encore plus bavard :</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;form_arrets&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;relais.html.php&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;a&#39;</span>     <span class="na">value</span><span class="o">=</span><span class="s">&#39;recherche_arrets&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;refs&#39;</span>  <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747608&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;code&#39;</span>  <span class="na">value</span><span class="o">=</span><span class="s">&#39;802&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;sens&#39;</span>  <span class="na">value</span><span class="o">=</span><span class="s">&#39;R&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;ligne&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;T1&#39;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;input&#39;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#39;width:100%;&#39;</span><span class="p">&gt;&lt;</span><span class="nt">span</span><span class="p">&gt;&lt;</span><span class="nt">em</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">select</span> <span class="na">onchange</span><span class="o">=</span><span class="s">&quot;new Timeo().parseValue(this.value);&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;combobox&#39;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;list_refs&#39;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;list_refs&#39;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747608_802&#39;</span> <span class="na">selected</span><span class="o">=</span><span class="s">&#39;selected&#39;</span><span class="p">&gt;</span>ANTARES MMArena (802)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747859_852&#39;</span><span class="p">&gt;</span>ATLANT.-SABLONS (852)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747844|271747588_842&#39;</span><span class="p">&gt;</span>CADRAN-EPINE (842)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747842|271747586_846&#39;</span><span class="p">&gt;</span>CAMPUS-RIBAY (846)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747858_850&#39;</span><span class="p">&gt;</span>CHURCHILL (850)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747603_812&#39;</span><span class="p">&gt;</span>DURAND-VAILLANT (812)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747861_856&#39;</span><span class="p">&gt;</span>EPAU-G.BERNISSON (856)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747849|271747593_832&#39;</span><span class="p">&gt;</span>EPERON (832)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747862_858&#39;</span><span class="p">&gt;</span>ESPAL (858)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747847|271747591_836&#39;</span><span class="p">&gt;</span>GAMBETTA-MURIERS (836)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747853|271747597_824&#39;</span><span class="p">&gt;</span>GARES (824)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747605_808&#39;</span><span class="p">&gt;</span>GLONNIERES (808)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747604_810&#39;</span><span class="p">&gt;</span>GOYA (810)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747607_804&#39;</span><span class="p">&gt;</span>GUETTELOUP (804)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747843|271747587_844&#39;</span><span class="p">&gt;</span>HAUTE VENELLE (844)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747845|271747589_840&#39;</span><span class="p">&gt;</span>HOPITAL (840)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747860_854&#39;</span><span class="p">&gt;</span>ILE AUX SPORTS (854)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747856|271747600_818&#39;</span><span class="p">&gt;</span>JAURES-PAVILLON (818)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747606_806&#39;</span><span class="p">&gt;</span>JULES RAIMU (806)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747848|271747592_834&#39;</span><span class="p">&gt;</span>LAFAYETTE (834)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747852|271747596_826&#39;</span><span class="p">&gt;</span>LECLERC-FLEURUS (826)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747602_814&#39;</span><span class="p">&gt;</span>PONTLIEUE (814)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747851|271747595_828&#39;</span><span class="p">&gt;</span>PREFECTURE (828)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747850|271747594_830&#39;</span><span class="p">&gt;</span>REPUBLIQUE (830)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747857|271747601_816&#39;</span><span class="p">&gt;</span>SAINT MARTIN (816)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747846|271747590_838&#39;</span><span class="p">&gt;</span>THEODORE MONOD (838)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747841|271747585_848&#39;</span><span class="p">&gt;</span>UNIVERSITE (848)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747855|271747599_820&#39;</span><span class="p">&gt;</span>VIADUCS (820)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;271747854|271747598_822&#39;</span><span class="p">&gt;</span>ZOLA (822)<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
<p>Là, c'est plus compliqué. Les 5 premiers champs sont plus où moins identifiables :</p>
<ul class="simple">
<li>application demandée (ici, recherche des arrêts)</li>
<li>référence (probablement un identifiant unique à la ressource demandée)</li>
<li>code de l'arrêt terminus</li>
<li>sens de circulation</li>
<li>ligne</li>
</ul>
<p>Arrive ensuite une liste d'arrêts dans ce sens assortis de leur numéro Timéo et d'une valeur qui ressemble à une
référence couplée à l'ID Timéo. Je ne sais pas comment elle sont calculée, mais en envoyant la bonne référence, on peut
demander n'importe quel arrêt et les prochains passage de bus/tram. Essayons d'en sélectionner un pour voir...</p>
<p>On tombe sur une page où des éléments sont affichés mais où le code source ne contient que des appels Ajax (ici en
cliquant sur l'arrêt Espal) :</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;consultation&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;br /&gt;&lt;i&gt;Veuillez patienter ...&lt;i&gt;&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Ajax</span><span class="p">(</span><span class="s1">&#39;consultation&#39;</span><span class="p">,</span><span class="s1">&#39;relais.html.php&#39;</span><span class="p">);</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Periodic</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">POST</span><span class="p">(</span><span class="s1">&#39;a=refresh\x26refs=271747862\x26ran=143268141&#39;</span><span class="p">);</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
</pre></div>
<p>On note que les paramètres de la <tt class="docutils literal">POST</tt> ne sont plus que 3</p>
<pre class="literal-block">
a:refresh
refs:271747862
ran:814240342
</pre>
<p>Il nous faudra parser ça pour récupérer le tout. La ref se retrouve via la page d'avant, le <tt class="docutils literal">a</tt> ne bouge pas, mais
<tt class="docutils literal">ran</tt> semble important.</p>
<p>Bon... ben on a tout. C'est parti pour du code :)</p>
<div class="section" id="code">
<h2>Code !</h2>
<p>Un petit module pour commencer :</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span> <span class="k">as</span> <span class="n">BS</span>

<span class="k">class</span> <span class="nc">Timeo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Interface entre Python et le service Timéo de la SETRAM &quot;&quot;&quot;</span>

    <span class="k">pass</span>
</pre></div>
<p>On aura en effet besoin de <tt class="docutils literal">BeautifulSoup</tt> pour le parsing de l'HTML, de <tt class="docutils literal">re</tt> pour l'extraction de données des
champs de texte et de <tt class="docutils literal">requests</tt> parce que l'<tt class="docutils literal">urllib</tt> python est dégueulasse.</p>
<p>Un petit constructeur ?</p>
<p>Alons y :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">URL</span><span class="o">=</span><span class="s2">&quot;http://dev.actigraph.fr/actipages/setram/module/mobile/pivk/relais.html.php&quot;</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">URL</span> <span class="o">=</span> <span class="n">URL</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>

    <span class="c1"># session init</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.57 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>

    <span class="c1"># regexs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extr_name_code</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;([^\(]+) \((\d+)\)&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extr_code</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\((\d+)\)&quot;</span><span class="p">)</span>
</pre></div>
<p>Je laisse l'URL paramétrable,... au cas où. La session permettra de retenir les cookies (automatiquement dans
<tt class="docutils literal">requests</tt>, tout comme le <em>header</em> <tt class="docutils literal"><span class="pre">Keep-Alive</span></tt>).</p>
<p>On prend aussi le temps de modifier l'<tt class="docutils literal"><span class="pre">User-Agent</span></tt> pour être sûr que l'API ne nous mette pas à la porte et le
<tt class="docutils literal"><span class="pre">Content-type</span></tt> parce que ça mange pas de pain que ça nous permet d'être au plus proche des <em>headers</em> qu'envoyait le
navigateur.</p>
<p>Je défini aussi deux regexes (que je vous laisse le soin de déchiffrer) qui nous serviront plus tard.</p>
<div class="section" id="liste-des-arrets">
<h3>Liste des arrêts</h3>
<p>Je pense qu'un bon début serait de récupérer la liste des arrêts pour un couple ligne/sens donné.
Je laisse la possibilité à la fonction d'extraire un attribut plutot que le nom de l'arrêt (la <tt class="docutils literal">value</tt> par exemple
pour récupérer les refs, vous vous souvenez ?) :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getall_arrets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lignesens</span><span class="p">,</span> <span class="n">attr_to_extract</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Récupére les informations sur tous les arrêts d&#39;une même ligne dans</span>
<span class="sd">    un sens de circulation donné (A ou R, voir API SETRAM... ahem.).</span>

<span class="sd">    lignesens : ligne à parser et sens de circulation (ex: 8_R , T1_A, ...)</span>
<span class="sd">    attr_to_extract : paramètre à extraire (par défaut : nom de l&#39;arrêt)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># on prépare le &quot;formulaire&quot;</span>
    <span class="n">POST_params_liste</span> <span class="o">=</span> <span class="p">{</span>
       <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;recherche_ligne&#39;</span><span class="p">,</span>
       <span class="s1">&#39;ligne_sens&#39;</span><span class="p">:</span> <span class="n">lignesens</span>
    <span class="p">}</span>

    <span class="c1"># on balance la requête et on parse le retour pour récupérer les options</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="n">POST_params_liste</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">BS</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>

    <span class="c1"># on reconstruit ensuite un dico à partir des options contenant soit :</span>
    <span class="c1"># - le code -&gt; le nom de l&#39;arrêt</span>
    <span class="c1"># - le coode -&gt; un attribut</span>
    <span class="k">if</span> <span class="n">attr_to_extract</span> <span class="o">==</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">extr_name_code</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">options</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extr_code</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_to_extract</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">options</span><span class="p">}</span>
</pre></div>
<div class="section" id="explication">
<h4>Explication</h4>
<p>Je vais expliquer ces deux lignes de <tt class="docutils literal">return</tt>.</p>
<p>Pour la première, on identifie le pattern de ListComprehension :</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="o">&lt;</span><span class="n">truc</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>
</pre></div>
<p>Regardons ce que fait &lt;truc&gt; :</p>
<div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">extr_name_code</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
<p>Alors... <tt class="docutils literal">self.extr_name_code</tt> c'est une instance de <tt class="docutils literal">re.RegexObject</tt> qu'on a défini dans le constructeur. On
appelle la méthode <tt class="docutils literal">search()</tt> et lui passant le texte à parser en argument. On récupère alors les groupes matché via
la méthode <tt class="docutils literal">group()</tt> et on inverse le tuple via <tt class="docutils literal"><span class="pre">t[::-1]</span></tt> (celle là, je l'expliquerais pas, allez revoir la doc sur
le slicing).</p>
<p>Finalement, on a une liste de tuples que l'on passe à la fonction <tt class="docutils literal">dict()</tt> qui en fait un dictionnaire.</p>
<p>Pour la deuxième maintenant, plus de ListComprehension mais directement un DictComprehension :</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="n">cle</span><span class="p">:</span><span class="n">valeur</span> <span class="k">for</span> <span class="n">truc</span> <span class="ow">in</span> <span class="n">bidule</span><span class="p">}</span>
</pre></div>
<p>Ici, bidule c'est notre liste d'options, truc, c'est la variable _ qui représente une option (avec ses attributs et son
text). Pour la clé on fait passer la regex <tt class="docutils literal">self.extr_code</tt> du début qui récupère le code de l'arrêt depuis <tt class="docutils literal">_.text</tt>
et pour la valeur, on récupère la valeur de l'attribut <tt class="docutils literal">attr_to_extract</tt> passé en paramètre à la fonction.</p>
<p>Voilà donc une fonction capable de nous récupérer une hashtable liant un code au nom de l'arrêt ou à un attribut lié à
ce code.</p>
</div>
</div>
<div class="section" id="recuperation-des-numeros-de-lignes">
<h3>Récupération des numéros de lignes</h3>
<p>Problème, il nous faut connaitre le numéro et le sens de la ligne pour utiliser la fonction précédente. On va donc les
récupérer depuis la première page (après l'iframe) :</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_lignes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Récupère une hashtable entre les lignes (et leur direction)</span>
<span class="sd">        et le code de ligne correspondant</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="n">_</span><span class="o">.</span><span class="n">text</span><span class="p">:</span><span class="n">_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
        <span class="n">BS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">URL</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>
</pre></div>
<p>Pas d'argument pour cette fonction. Elle récupère le code HTML de la page pointée par <tt class="docutils literal">self.URL</tt>, le parse et cherche
toutes les options. Elle itère alors sur cette liste d'options en excluant toutes celle qui ne contiennent pas de <tt class="docutils literal">&gt;</tt>.
Pourquoi cela ? parce que la seule option n'en contenant pas contient : <em>&quot;Sélectionnez une ligne&quot;</em>, ce qui ne nous
intéresse pas. Finalement on construit le dico avec comme clé le nom de la ligne et comme valeur la <em>value</em> de l'option
correspondante. Cette <em>value</em> contient en effet le code de la ligne (numéro et sens).</p>
</div>
<div class="section" id="informations-sur-un-arret">
<h3>Informations sur un arrêt</h3>
<p>C'est la dernière partie. Etant donnés un code de ligne/sens et un code Timéo d'arrêt, on cherche à récupérer les
prochains horaires de passage.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_arret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lignesens</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Récupère les prochains passages à un arret donné</span>

<span class="sd">    lignesens : code de ligne (ligne+sens, voir get_ligne())</span>
<span class="sd">    code : code timéo de l&#39;arret</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># on sépare le paramètre lignesens en utilisant un tuple unpacking</span>
    <span class="n">ligne</span><span class="p">,</span><span class="n">sens</span> <span class="o">=</span> <span class="n">lignesens</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="c1"># on s&#39;assure que le code est bien une str</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="c1"># récupération des références</span>
    <span class="c1"># souvenez vous celles ci sont importantes, peuvent être complexes</span>
    <span class="c1"># et surtout ne sont pas recalculable (en tout cas, on ne sait pas</span>
    <span class="c1"># le faire) on utilise donc la première méthode écrite pour récupérer</span>
    <span class="c1"># la liste des codes et la reférence associée</span>
    <span class="n">refs_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getall_arrets</span><span class="p">(</span><span class="n">lignesens</span><span class="p">,</span> <span class="n">attr_to_extract</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

    <span class="c1"># on crée le dico pour le post en respectant le format</span>
    <span class="c1"># répéré dans les headers tout à l&#39;heure</span>
    <span class="n">POST_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;recherche_arrets&#39;</span><span class="p">,</span>
        <span class="s1">&#39;refs&#39;</span><span class="p">:</span> <span class="n">refs_all</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># les références récupérées sont suivies</span>
                                              <span class="c1"># d&#39;un _ puis du code de l&#39;arrêt. On</span>
                                              <span class="c1"># splite pour ne garde que la ref</span>
        <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s1">&#39;sens&#39;</span><span class="p">:</span> <span class="n">sens</span><span class="p">,</span>
        <span class="s1">&#39;ligne&#39;</span><span class="p">:</span> <span class="n">ligne</span><span class="p">,</span>
        <span class="s1">&#39;list_refs&#39;</span><span class="p">:</span> <span class="n">refs_all</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># On envoie ce formulaire et on récupère le</span>
    <span class="c1"># paramètre ran dans la requuete Ajax de la page suivante.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">POST_params</span><span class="p">)</span>
    <span class="n">ran</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
        <span class="s2">&quot;ran=(\d+)&quot;</span><span class="p">,</span>
        <span class="n">BS</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Explication :</span>
    <span class="c1"># BS(res.text).find_all(&#39;script&#39;) : parsing du HTML et récupération</span>
    <span class="c1">#                                       de la liste des balises script</span>
    <span class="c1"># [-1].text                       : on a besoin que du texte du</span>
    <span class="c1">#                                       dernier script</span>
    <span class="c1"># .splitlines()[-2]               : on splite le texte du script à</span>
    <span class="c1">#                                       chaque \n et on garde l&#39;avant</span>
    <span class="c1">#                                       dernière ligne (celle avec la requête)</span>
    <span class="c1"># On passe le tout au search par regex et on récupère</span>
    <span class="c1"># le groupe matché qui correspond à la valeur de ran</span>


    <span class="c1"># on prépare le formulaire suivant</span>
    <span class="n">POST_params2</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span> <span class="p">:</span> <span class="s1">&#39;refresh&#39;</span><span class="p">,</span>
        <span class="s1">&#39;refs&#39;</span><span class="p">:</span> <span class="n">POST_params</span><span class="p">[</span><span class="s1">&#39;refs&#39;</span><span class="p">],</span>
        <span class="s1">&#39;ran&#39;</span> <span class="p">:</span> <span class="n">ran</span>
    <span class="p">}</span>

    <span class="c1"># on l&#39;envoie pour récupérer la page avec des vraies données.</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">POST_params2</span><span class="p">)</span>
    <span class="c1"># les stops sont les contenus des li où sont notés les temps (le premier ne</span>
    <span class="c1"># nous sert pas, d&#39;où le [:1]</span>
    <span class="n">stops</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">BS</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]]</span>

    <span class="c1"># liste des heures d&#39;arrêt finale</span>
    <span class="n">stoptimes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stops</span><span class="p">:</span>
        <span class="c1"># si on trouve le mot &quot;imminent&quot; ou &quot;en cours&quot;, on ajoute</span>
        <span class="c1"># &quot;maintenant&quot; à la liste</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;imminent&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;en cours&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">stoptimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;maintenant&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># sinon, on a soit un nombre de minutes sous la forme &quot;XX minutes&quot;</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(\d+ minutes?)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">next</span><span class="p">:</span>
                <span class="c1"># soit une heure &quot;XX H XX&quot;</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(\d+ H \d+)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="c1"># quoiqu&#39;il en soit, on prend ce qu&#39;on trouve</span>
            <span class="n">stoptimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># et on renvoie la liste.</span>
    <span class="k">return</span> <span class="n">stoptimes</span>
</pre></div>
<p>Ça nous fait un gros module bien velu parce que le site sur lequel on cherche les données n'a pas été prévu pour ça. Si
l'ergonomie du site est pas trop mal pour un humain, c'est une plaie pour un programme. Mais bon... bref. On l'a eu :)</p>
<p>Pour le code complet, <a class="reference external" href="https://gist.github.com/Matael/6742478">c'est ici</a> !</p>
</div>
</div>
<div class="section" id="exemple-d-utilisation">
<h2>Exemple d'utilisation</h2>
<p>Le code suivant affichera d'abord la liste des lignes et le code leur étant associé, puis la liste des arrêts pour la
ligne de tram vers Espal/Antares et enfin le temps avant le prochain passage d'un tram à chaque arrêt (dans la direction
Espal/Antares) :</p>
<div class="highlight"><pre><span></span><span class="c1"># on instancie l&#39;interface</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Timeo</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Liste des lignes et des codes associés :&quot;</span><span class="p">)</span>
<span class="n">liste</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_lignes</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">liste</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">+</span><span class="n">v</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Liste des arrêts et de leur code pour la ligne T1_R :&quot;</span><span class="p">)</span>
<span class="n">arrets</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">getall_arrets</span><span class="p">(</span><span class="s1">&#39;T1_R&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">arrets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">+</span><span class="n">v</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Temps avant l&#39;arrivé du prochain tram pour les arrêts de T1_R :&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">arrets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Arrivé à l&#39;arret &quot;</span><span class="o">+</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot; : &quot;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">get_arret</span><span class="p">(</span><span class="s1">&#39;T1_R&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Je ne prétends pas avoir fait un travail parfait. L'idéal serait clairement une API prévue pour ça. Je dis simplement
qu'en peu de temps on peu récupérer des données utilisables. Et que si un peu de temps avait été consacré par les
&quot;propriétaires&quot; des données, ce serait franchement plus simple.</p>
<p>Ces données sont des données de mobilité intéressant potentiellement un très grand nombre de personnes et qui ont <strong>tout
à gagner</strong> à être ouvertes. Devoir parser du HTML <em>a la mano</em> pour récupérer des horaires de tram, c'est une aberration
à l'heure où tout le monde parle d'OpenData.</p>
<p>Si le courage me prends, je mettrais en ligne une API permettant d'utiliser facilement les données ainsi parsées à
partir de simple requêtes HTTP. Ce n'est pas mon job, mais aujourd'hui, il y a une certaine demande vis à vis de l'accès
à ces données.</p>
<p>A bon entendeur</p>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>