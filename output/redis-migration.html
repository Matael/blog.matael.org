<!DOCTYPE html>
<html lang="en">
	<head>
			<title>Thinking at Random</title>
		<meta charset="utf-8" />


		<meta name="tags" content="redis" />
		<meta name="tags" content="imported" />

		<link rel=stylesheet/less type=text/css media=screen href="/theme/css/style.css" />
		<link rel=stylesheet type=text/css media=screen href="/theme/css/pygment.css" />
		<script src="/theme/js/less.min.js"></script>
	</head>

	<body>
		<div id=logo><div id=logo-wrapper>
			<header>
				<h1><a href="/"<span class=overbar><span class=big>t</span>hinking <span class=accent>at</span> <span class=big>r</span>andom</span></a></h1>
			</header>
			<nav>
				<ul>
					<li><a href="/">Writing</a></li>
					<li><a href="https://github.com/Matael">Github</a></li>
					<li><a href="https://matael.org">About</a></li>
				</ul>
			</nav>
		</div></div>
		<div id=page>
<section id=content>
	<header>
		<h1>Redis migration</h1>
		
	</header>
	<article>

	<div id=meta>
		<p class=by-line>Published by 
				<a href="/author/matael.html" class=author>matael</a>
		</p>
		<p>On <time datetime="2015-01-04T11:28:38+01:00">Sun 04 January 2015</span></p>
		<ul class=tags>
				<li><a href="/tag/redis.html">redis</a></li>
				<li><a href="/tag/imported.html">imported</a></li>
		</ul>
	</div>
	<div id=article_body>
		<p>I'm currently trying to migrate all the content from a server (<em>marvin</em>) to another (<em>vogon</em>, thanks to lidstah for this name).
Moreover, I also want all the services running on the old one to run on the new, and sometimes it's.... annoying.</p>
<p>Some of the websites running on these servers, use a <a class="reference external" href="http://redis.io">redis</a> instance.
Even if I do not store large amounts of data in the databases, I thought it was not elegant to dump everything from <em>marvin</em> in order to load it back in <em>vogon</em>.</p>
<p>Skimming through the doc, I found an interesting redis feature : one can define a master instance on the fly and replicate data from this master.</p>
<div class="section" id="master">
<h2>master</h2>
<p>On the <em>master</em> side, we just have to check that the <tt class="docutils literal">bind</tt> parameter is not set in the config file (or to make the server listen the future slave's IP address).
In fact, this parameter specifies which address will be allowed to connect the server.</p>
<p>If this param is set, just add the slave's IP address to the list or comment the line and then restart the server.</p>
</div>
<div class="section" id="slave">
<h2>slave</h2>
<p>On the <em>slave</em>, you won't have to modify the config file : just run <tt class="docutils literal"><span class="pre">redis-cli</span></tt> in a console to access the server and run</p>
<pre class="literal-block">
SLAVEOF &lt;slave ip or domain name&gt; &lt;port&gt;
</pre>
<p>Wait a bit (syncing between master and slave is automatic on connection)
For a quite <em>&quot;small&quot;</em>  redis instance, the process completes in seconds.</p>
<p>Once syncing's over, just disconnect using</p>
<pre class="literal-block">
SLAVEOF NO ONE
</pre>
<p>and... that's all !</p>
</div>
<div class="section" id="why-this-is-so-cool">
<h2>Why this is so cool</h2>
<p>In several ways, this method is powerful :</p>
<ul class="simple">
<li>if you want to keep the data up-to-date on the future server before migrating the entire app, just do that and disconnect once the migration of the full app is complete.</li>
<li>if you have set <tt class="docutils literal">bind</tt> but can't restart the redis server, you can launch another instance locally with a different config file (different port and bind unset or correctly set), accepting external connections and sync with this one instead of the real targeted one (which will probably share data with the other or, if not, will be slave of the root instance).</li>
</ul>
<div class="section" id="one-more-thing">
<h3>One more thing</h3>
<p>During the whole server migration, I had a problem with a phpBB installation I needed.
Database restoration and hardcore dump from <em>marvin</em> and load into <em>vogon</em> failed so I decided to migrate everything by hand.</p>
<p>The <em>working</em> process is (I'm running PostgreSQL):</p>
<ol class="arabic simple">
<li>install dummy instance to force database structure creation</li>
<li>empty all the tables in the new DB (phpBB fills it with some data)</li>
<li>dump each table data separatly from old server</li>
<li>inject this data into the new</li>
<li>dump all <em>sequences</em> from old server</li>
<li>inject it into the new</li>
</ol>
<p>The two last steps avoid rupture of constraints (particularly on <tt class="docutils literal">post_id</tt> field)</p>
</div>
</div>

	</article>
</section>
		</div>
		<div class=clear>&nbsp;</div>
		<footer>
			<p id=legal>Proudly powered by Pelican &mdash; 2017 &mdash; Mathieu (matael) Gaborit</p>
		</footer>
	</body>
</html>